<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Prezen»õƒÉ GrƒÉdini»õƒÉ</title>

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="application-name" content="GrƒÉdini»õƒÉ">
<meta name="apple-mobile-web-app-title" content="GrƒÉdini»õƒÉ">
<meta name="theme-color" content="#3498db">
<meta name="msapplication-navbutton-color" content="#3498db">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="msapplication-starturl" content="/index.html">

<link rel="icon" type="image/png" sizes="192x192" href="https://via.placeholder.com/192.png?text=G">
<link rel="apple-touch-icon" type="image/png" sizes="192x192" href="https://via.placeholder.com/192.png?text=G">

<link rel="manifest" href="manifest.json">

<style>
/* --- Layout general --- */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  padding: 0;
  background: #f0f4f7;
  color: #333;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
}

/* Container central care √ÆncadrƒÉ tot con»õinutul */
.container {
  <div id="update-message" style="display:none; position:fixed; bottom:20px; right:20px; background:#e74c3c; color:white; padding:15px; border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,0.2); z-index:10000;">
    O actualizare este disponibilƒÉ! <button onclick="window.location.reload(true)" style="background:#2ecc71; margin-left:10px;">Re√ÆncƒÉrca»õi acum</button>
</div>
  max-width: 1100px;
  width: 95%;
  background: #fff;
  margin: 20px;
  padding: 24px;
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.1);
}

/* Titlu */
h1 {
  text-align: center;
  color: #2c3e50;
  margin-top: 0;
  font-size: 2.2em;
}
h2 {
    font-size: 1.4em;
    color: #34495e;
    border-bottom: 2px solid #ecf0f1;
    padding-bottom: 8px;
    margin-top: 24px;
}

/* Butoane */
button {
  padding: 10px 18px;
  margin: 6px 4px;
  cursor: pointer;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  background: #3498db;
  color: white;
  transition: background-color 0.2s, transform 0.1s;
}
button:hover { background: #2980b9; transform: translateY(-1px); }
.button-group { display: flex; flex-wrap: wrap; justify-content: center; margin-bottom: 12px; }

/* Calendar - grid 7 coloane */
.calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  margin: 16px 0 20px 0;
}
.day {
  border-radius: 10px;
  min-height: 55px;
  text-align: center;
  border: 1px solid #ddd;
  cursor: pointer;
  user-select: none;
  font-size: 15px;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  line-height: 1.3;
  transition: background-color 0.3s, transform 0.1s;
}
.day:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.day .day-number { font-size: 15px; margin-top: 6px; font-weight: bold; }
.day-header {
  font-weight: 700;
  background: #ecf0f1;
  border-radius: 10px;
  padding: 8px 0;
  text-align: center;
}
.day.weekend { color: #888; }
.day.holiday { background-color: #e8f4fb; border-color: #bce0f6; }

/* Indicatori activitate zilnicƒÉ */
.day .indicators {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 3px;
  margin-top: 4px;
  margin-bottom: 4px;
}
.day .indicators .indicator {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  border: 1px solid rgba(0,0,0,0.1);
}
.day.note-indicator::after {
    content: "üìù";
    position: absolute;
    top: 4px;
    right: 4px;
    font-size: 10px;
}
/* Indicator pentru plata */
.day .payment-indicator::after {
    content: "üíµ";
    position: absolute;
    bottom: 4px;
    left: 4px;
    font-size: 12px;
}

/* Rapoarte copii */
.report {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  justify-content: center;
  margin-bottom: 24px;
}
.child-report {
  background: #f8f8f8;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  padding: 16px;
  min-width: 280px;
  box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
}
.child-report h3 {
  margin: 0 0 12px 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 1.2em;
}
.child-report h3 span { font-weight: bold; }

/* Inputs */
input[type="number"], input[type="text"], select {
  width: 95%;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin: 6px 0;
  box-sizing: border-box;
}

/* Popup (modals) */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
  backdrop-filter: blur(4px);
  justify-content: center;
  align-items: center;
}
.modal-content {
  background-color: #fff;
  padding: 24px;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  max-width: 500px;
  width: 90%;
  position: relative;
  animation: modal-fadein 0.3s ease-out;
}
.modal-close {
  color: #aaa;
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}
.modal-close:hover, .modal-close:focus { color: #000; text-decoration: none; }
@keyframes modal-fadein { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

/* LegendƒÉ culori */
.legend {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  justify-content: center;
  margin-top: 20px;
  padding: 12px;
  background: #f8f8f8;
  border-radius: 12px;
  border: 1px solid #eee;
}
.legend-item { display: flex; gap: 8px; align-items: center; font-size: 14px; }
.color-box { width: 20px; height: 20px; border-radius: 6px; border: 1px solid rgba(0,0,0,0.08); }

/* Detalii contabile */
.accounting-section {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    justify-content: center;
    margin-top: 24px;
}
.payment-history {
    background: #f8f8f8;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 16px;
    flex: 1;
    min-width: 300px;
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
}
.payment-list { list-style-type: none; padding: 0; }
.payment-list li {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 8px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.payment-list li button {
    background: none;
    border: none;
    color: #e74c3c;
    font-size: 1.2em;
    padding: 0;
    margin: 0;
}
.payment-input-group { display: flex; gap: 8px; }

/* Stiluri specifice pentru popup */
.day-popup-section {
  border-bottom: 1px solid #eee;
  padding-bottom: 10px;
  margin-bottom: 10px;
}
.day-popup-section h4 { margin: 0 0 10px 0; font-size: 1.1em; }
.day-popup-section button.active {
    background: #2ecc71;
    color: white;
    border-color: #2ecc71;
}

/* Grafice */
#chartContainer {
    max-width: 600px;
    margin: 20px auto;
    background: #f8f8f8;
    padding: 15px;
    border-radius: 12px;
    border: 1px solid #e0e0e0;
}

/* Stiluri pentru raportul general */
#generalReportContainer {
    margin-top: 20px;
}
#generalReportTable {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}
#generalReportTable th, #generalReportTable td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}
#generalReportTable th {
    background-color: #3498db;
    color: white;
}
#generalReportTable tr:nth-child(even) { background-color: #f2f2f2; }
.report-options {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    margin-bottom: 15px;
}

@media (max-width:768px) {
  .day { min-height:48px; }
  .day-header { padding: 6px 0; }
  button { width:100%; margin: 6px 0; }
  .child-report { min-width:unset; width:100%; }
  .container { padding:16px; margin:10px; }
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
<div class="container">
  <h1>Prezen»õƒÉ GrƒÉdini»õƒÉ</h1>

  <div style="text-align:center; margin-bottom:12px; display:flex; align-items:center; justify-content:center; gap:8px;">
    <button onclick="changeMonth(-1)">‚¨Ö</button>
    <select id="monthSelectNav" onchange="changeMonthToSelected()">
        <option value="0">Ianuarie</option><option value="1">Februarie</option><option value="2">Martie</option>
        <option value="3">Aprilie</option><option value="4">Mai</option><option value="5">Iunie</option>
        <option value="6">Iulie</option><option value="7">August</option><option value="8">Septembrie</option>
        <option value="9">Octombrie</option><option value="10">Noiembrie</option><option value="11">Decembrie</option>
    </select>
    <input type="number" id="yearSelectNav" onchange="changeMonthToSelected()" value="" style="width:80px; text-align:center;" />
    <button onclick="changeMonth(1)">‚û°</button>
  </div>

  <div id="calendar" class="calendar"></div>

  <div id="chartContainer">
      <canvas id="myChart"></canvas>
  </div>

  <div class="report" id="childrenReports"></div>

  <div class="button-group">
    <button onclick="addChild()">‚ûï AdaugƒÉ copil</button>
    <button onclick="resetData()">üóëÔ∏è Resetare date</button>
    <button onclick="exportJSON()">üíæ Export JSON</button>
    <input type="file" id="importFile" style="display:none" accept=".json" onchange="importJSON(event)">
    <button onclick="document.getElementById('importFile').click()">üìÇ Import JSON</button>
  </div>

  <div class="button-group">
    <button onclick="exportExcel()">üìä Export Excel</button>
    <button onclick="exportPDF()">üìÑ Export PDF</button>
    <button onclick="showGeneralReportModal()">üìà Generare Raport General</button>
  </div>

  <div class="legend" id="legend"></div>
</div>
   <div class="legend" id="legend"></div>
</div>

<footer style="text-align:center; padding:10px 0; margin-top:20px; font-size:0.8em; color:#7f8c8d;">
    <p>Aplica»õie dezvoltatƒÉ de: <span style="font-weight:bold; color:#3498db;">ASWY</span></p>
</footer>

<div id="dayModal" class="modal">
...
<div id="dayModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('dayModal')">&times;</span>
        <h3 style="text-align: center;">Detalii pentru ziua <span id="modalDayNumber"></span></h3>

        <div class="day-popup-section">
            <h4>Prezen»õƒÉ »ôi activitƒÉ»õi</h4>
            <div id="childSelectionButtons"></div>
        </div>

        <div class="day-popup-section">
            <h4>Noti»õe</h4>
            <textarea id="noteTextarea" placeholder="AdaugƒÉ o noti»õƒÉ (ex: schemƒÉ de m√¢ncare, observa»õie)..." style="width: 100%; height: 80px;"></textarea>
            <button onclick="saveNote()">SalveazƒÉ noti»õa</button>
        </div>

        <div style="display: flex; justify-content: space-between; gap: 8px;">
            <button style="background-color: #e74c3c; width: 100%;" onclick="clearDaySelections()">»òterge toate selec»õiile</button>
            <button style="background-color: #3498db; width: 100%;" onclick="closeModal('dayModal')">√énchide</button>
        </div>
    </div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('settingsModal')">&times;</span>
        <h3>SetƒÉri pentru <span id="settingsChildName"></span></h3>
        <label>Nume copil:</label><br>
        <input type="text" id="editChildName" /><br>
        <label>Cost standard GrƒÉdini»õƒÉ:</label><br>
        <input type="number" id="editDefaultRate" /><br>
        <label>Culoare GrƒÉdini»õƒÉ:</label><br>
        <input type="color" id="editChildColor" /><br>
        <label>Nume activitate suplimentarƒÉ:</label><br>
        <input type="text" id="editExtraName" /><br>
        <label>Cost standard activitate:</label><br>
        <input type="number" id="editDefaultExtraRate" /><br>
        <label>Culoare activitate:</label><br>
        <input type="color" id="editExtraColor" /><br>
        <div style="display:flex; justify-content:space-between; margin-top:10px;">
            <button style="background: #e74c3c; flex: 1; margin: 0 4px;" onclick="deleteChild()">»òterge copil</button>
            <button style="background: #2ecc71; flex: 1; margin: 0 4px;" onclick="saveChildSettings()">SalveazƒÉ</button>
        </div>
    </div>
</div>

<div id="paymentsModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('paymentsModal')">&times;</span>
        <h3>Istoric plƒÉ»õi <span id="paymentsChildName"></span> (<span id="paymentsMonth"></span>)</h3>
        <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;">
            <div style="display: flex; gap: 8px;">
                <input type="number" id="newPaymentAmount" placeholder="SumƒÉ" style="flex: 1;"/>
                <input type="date" id="newPaymentDate" style="flex: 1;"/>
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
                <label>PlatƒÉ pentru:</label>
                <select id="newPaymentType" style="flex: 1;">
                    <option value="kindergarten">GrƒÉdini»õƒÉ</option>
                    <option value="extra">Activitate SuplimentarƒÉ</option>
                </select>
                <label>Culoare platƒÉ:</label>
                <input type="color" id="newPaymentColor" value="#2ecc71" style="width: 50px;"/>
            </div>
            <button onclick="addPayment()">AdaugƒÉ platƒÉ</button>
        </div>
        <ul id="paymentList" class="payment-list"></ul>
        <div style="margin-top: 15px; font-weight: bold; font-size: 1.1em;">
            Total plƒÉtit: <span id="paymentsTotal">0</span>
        </div>
    </div>
</div>

<div id="generalReportModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <span class="modal-close" onclick="closeModal('generalReportModal')">&times;</span>
        <h3 style="text-align: center;">Raport General</h3>
        <div class="report-options">
            <label>An:</label>
            <select id="reportYearSelect"></select>
            <label>LunƒÉ:</label>
            <select id="reportMonthSelect">
                <option value="-1">Toate lunile</option>
                <option value="0">Ianuarie</option><option value="1">Februarie</option><option value="2">Martie</option>
                <option value="3">Aprilie</option><option value="4">Mai</option><option value="5">Iunie</option>
                <option value="6">Iulie</option><option value="7">August</option><option value="8">Septembrie</option>
                <option value="9">Octombrie</option><option value="10">Noiembrie</option><option value="11">Decembrie</option>
            </select>
            <button onclick="generateGeneralReport()">GenereazƒÉ Raport</button>
        </div>
        <div id="generalReportContainer"></div>
    </div>
</div>

<script>
/* ================== VARIABILE & CONFIG ================== */
const STORAGE_KEY = 'gradinitaDataV5'; // V5 pentru a asigura resetarea
const BACKUP_INTERVAL_MS = 60 * 60 * 1000;
let lastBackupTime = 0;

let today = new Date();
let month = today.getMonth();
let year = today.getFullYear();
let selectedDay = null;
let selectedCell = null;
let chartInstance = null;
let selectedChildIdForModal = null;

/* ================== HELPER: load/save localStorage ================== */
const loadData = () => {
    try {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        if (!data.children || typeof data.children !== 'object') {
            data.children = {};
        }
        return data;
    } catch (e) {
        console.error("Failed to load data from localStorage", e);
        return { children: {} };
    }
};

const saveData = (data) => {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
        console.error("Failed to save data to localStorage", e);
    }
};

const sanitize = (input) => {
    if (typeof input !== 'string') return input;
    const temp = document.createElement('div');
    temp.textContent = input;
    return temp.innerHTML;
};

/* ================== RENDER: calendar + rapoarte ================== */
const renderCalendar = () => {
    const calendar = document.getElementById('calendar');
    calendar.innerHTML = '';
    const data = loadData();
    const key = `${year}-${month}`;

    if (!data[key]) {
        data[key] = {
            days: {},
            daysExtra: {},
            rates: {},
            notes: {},
            extraRates: {},
            payments: {},
            holidays: [],
            paymentsOnDay: {}
        };
        saveData(data);
    }

    const weekdays = ['Lu', 'Ma', 'Mi', 'Jo', 'Vi', 'Sa', 'Du'];
    weekdays.forEach((w, idx) => {
        const el = document.createElement('div');
        el.className = 'day-header';
        if (idx >= 5) el.classList.add('weekend');
        el.textContent = w;
        calendar.appendChild(el);
    });

    const firstDay = new Date(year, month, 1).getDay();
    const empty = firstDay === 0 ? 6 : firstDay - 1;
    for (let i = 0; i < empty; i++) calendar.appendChild(document.createElement('div'));

    const daysInMonth = new Date(year, month + 1, 0).getDate();
    for (let d = 1; d <= daysInMonth; d++) {
        const day = document.createElement('div');
        day.className = 'day';
        day.dataset.day = d;
        day.innerHTML = `<span class="day-number">${d}</span>`;
        if (new Date(year, month, d).getDay() === 0 || new Date(year, month, d).getDay() === 6) {
            day.classList.add('weekend');
        }
        day.onclick = (e) => showDayModal(d, day);
        updateDayDisplay(day, d, data[key]);
        calendar.appendChild(day);
    }

    const monthLabelNav = document.getElementById('monthSelectNav');
    const yearLabelNav = document.getElementById('yearSelectNav');
    monthLabelNav.value = month;
    yearLabelNav.value = year;

    renderChildrenReports();
    renderLegend();
    renderChart();
};

const updateDayDisplay = (cell, day, monthData) => {
    cell.style.backgroundColor = '';
    cell.style.color = '#333';
    cell.style.border = '1px solid #ddd';
    cell.style.background = '';
    cell.classList.remove('note-indicator', 'payment-indicator');

    let indicators = cell.querySelector('.indicators');
    if(indicators) indicators.remove();
    indicators = document.createElement('div');
    indicators.className = 'indicators';

    if (!monthData) return;

    if(monthData.notes && monthData.notes[day]){
        cell.classList.add('note-indicator');
    }

    if(monthData.holidays && monthData.holidays.includes(day)){
        cell.classList.add('holiday');
        return;
    }

    const childrenData = loadData().children;
    const paymentIndicators = [];

    // VerificƒÉ prezen»õele
    for (const childId of Object.keys(childrenData)) {
        if (monthData.days[childId] && monthData.days[childId].includes(day)) {
            const indicator = document.createElement('div');
            indicator.className = 'indicator';
            indicator.style.backgroundColor = childrenData[childId]?.color || '#3498db';
            indicators.appendChild(indicator);
        }
        if (monthData.daysExtra[childId] && monthData.daysExtra[childId].includes(day)) {
            const indicator = document.createElement('div');
            indicator.className = 'indicator';
            indicator.style.backgroundColor = childrenData[childId]?.extraColor || '#9b59b6';
            indicators.appendChild(indicator);
        }
    }

    // VerificƒÉ plƒÉ»õile pentru ziua respectivƒÉ
    if(monthData.paymentsOnDay && monthData.paymentsOnDay[day]) {
      const paymentInfo = monthData.paymentsOnDay[day];
      if(paymentInfo.length > 0) {
        // Po»õi alege sƒÉ arƒÉ»õi un singur indicator pentru toate plƒÉ»õile din zi
        const indicator = document.createElement('div');
        indicator.className = 'indicator';
        // Folose»ôte culoarea salvatƒÉ la adƒÉugarea plƒÉ»õii
        indicator.style.backgroundColor = paymentInfo[0].color;
        indicators.appendChild(indicator);
      }
    }

    if (indicators.children.length > 0) {
        cell.appendChild(indicators);
    }
};


/* ================== MODALS ================== */
const openModal = (modalId) => {
    const modal = document.getElementById(modalId);
    modal.style.display = 'flex';
};

const closeModal = (modalId) => {
    const modal = document.getElementById(modalId);
    modal.style.display = 'none';
};

const showDayModal = (day, elCell) => {
    selectedDay = day;
    selectedCell = elCell;
    document.getElementById('modalDayNumber').textContent = day;
    const data = loadData();
    const key = `${year}-${month}`;
    const children = data.children || {};
    const childSelectionButtons = document.getElementById('childSelectionButtons');
    childSelectionButtons.innerHTML = '';

    const isHoliday = data[key].holidays && data[key].holidays.includes(day);
    const holidayBtn = document.createElement('button');
    holidayBtn.textContent = isHoliday ? 'AnuleazƒÉ zi liberƒÉ' : 'MarcheazƒÉ ca zi liberƒÉ';
    holidayBtn.style.backgroundColor = isHoliday ? '#e74c3c' : '#2ecc71';
    holidayBtn.onclick = toggleHoliday;
    childSelectionButtons.appendChild(holidayBtn);

    for (const id of Object.keys(children)) {
        const isKindergartenActive = data[key].days[id] && data[key].days[id].includes(day);
        const isExtraActive = data[key].daysExtra[id] && data[key].daysExtra[id].includes(day);

        const childSection = document.createElement('div');
        childSection.className = 'selection-buttons';
        childSection.innerHTML = `
            <span>${sanitize(children[id].name)}</span>
            <button class="${isKindergartenActive ? 'active' : ''}" onclick="togglePresence('${id}', 'kindergarten', this)">GrƒÉdini»õƒÉ</button>
            <button class="${isExtraActive ? 'active' : ''}" onclick="togglePresence('${id}', 'extra', this)">${sanitize(children[id].extraName)}</button>
        `;
        childSelectionButtons.appendChild(childSection);
    }

    const existingNote = (data[key].notes && data[key].notes[selectedDay]) || '';
    document.getElementById('noteTextarea').value = sanitize(existingNote);

    openModal('dayModal');
};

const saveNote = () => {
    const data = loadData();
    const key = `${year}-${month}`;
    if (!data[key].notes) data[key].notes = {};
    const note = document.getElementById('noteTextarea').value.trim();
    if (note) {
        data[key].notes[selectedDay] = sanitize(note);
    } else {
        delete data[key].notes[selectedDay];
    }
    saveData(data);
    updateDayDisplay(selectedCell, selectedDay, data[key]);
    closeModal('dayModal');
};

const clearDaySelections = () => {
    if (selectedDay === null) return;
    const data = loadData();
    const key = `${year}-${month}`;
    for (const childId in data.children) {
        if (data[key].days[childId]) {
            data[key].days[childId] = data[key].days[childId].filter(d => d !== selectedDay);
        }
        if (data[key].daysExtra[childId]) {
            data[key].daysExtra[childId] = data[key].daysExtra[childId].filter(d => d !== selectedDay);
        }
    }
    if (data[key].holidays) {
        data[key].holidays = data[key].holidays.filter(d => d !== selectedDay);
    }
    if (data[key].notes) {
        delete data[key].notes[selectedDay];
    }
    saveData(data);
    updateDayDisplay(selectedCell, selectedDay, data[key]);
    closeModal('dayModal');
};

const toggleHoliday = () => {
    const data = loadData();
    const key = `${year}-${month}`;
    if (!data[key].holidays) data[key].holidays = [];

    const index = data[key].holidays.indexOf(selectedDay);
    if(index > -1){
        data[key].holidays.splice(index, 1);
    } else {
        data[key].holidays.push(selectedDay);
    }
    saveData(data);
    updateDayDisplay(selectedCell, selectedDay, data[key]);
    closeModal('dayModal');
};

const togglePresence = (childId, type, button) => {
    if (selectedDay === null) return;
    const data = loadData();
    const key = `${year}-${month}`;

    if (data[key].holidays && data[key].holidays.includes(selectedDay)) {
        data[key].holidays = data[key].holidays.filter(d => d !== selectedDay);
    }

    const daysField = type === 'kindergarten' ? 'days' : 'daysExtra';
    if (!data[key][daysField][childId]) data[key][daysField][childId] = [];
    const daysArray = data[key][daysField][childId];
    const index = daysArray.indexOf(selectedDay);
    if (index > -1) {
        daysArray.splice(index, 1);
        button.classList.remove('active');
    } else {
        daysArray.push(selectedDay);
        button.classList.add('active');
    }
    saveData(data);
    updateDayDisplay(selectedCell, selectedDay, data[key]);
};


/* ================== RENDER rapoarte per copil ================== */
const renderChildrenReports = () => {
    const container = document.getElementById('childrenReports');
    container.innerHTML = '';
    const data = loadData();
    if (!data.children) data.children = {};
    const key = `${year}-${month}`;
    if (!data[key]) data[key] = {
        days: {}, daysExtra: {}, rates: {}, notes: {}, extraRates: {}, payments: {}, holidays: [], paymentsOnDay: {}
    };

    for (const id of Object.keys(data.children)) {
        if (!data[key].days[id]) data[key].days[id] = [];
        if (!data[key].daysExtra[id]) data[key].daysExtra[id] = [];
        if (!data[key].rates[id]) data[key].rates[id] = data.children[id].defaultRate || 15;
        if (!data[key].extraRates[id]) data[key].extraRates[id] = data.children[id].defaultExtraRate || 0;
        if (!data[key].payments[id]) data[key].payments[id] = [];

        const daysKindergarten = data[key].days[id].length;
        const daysExtra = data[key].daysExtra[id].length;
        const totalKindergarten = daysKindergarten * (data[key].rates[id] || 0);
        const totalExtra = daysExtra * (data[key].extraRates[id] || 0);
        const totalCalculated = totalKindergarten + totalExtra;

        const totalPaidKindergarten = data[key].payments[id].filter(p => p.type === 'kindergarten').reduce((sum, p) => sum + parseFloat(p.amount), 0);
        const totalPaidExtra = data[key].payments[id].filter(p => p.type === 'extra').reduce((sum, p) => sum + parseFloat(p.amount), 0);
        const totalPaid = totalPaidKindergarten + totalPaidExtra;

        const diff = totalCalculated - totalPaid;

        const div = document.createElement('div');
        div.className = 'child-report';
        div.innerHTML = `
            <h3>
                <span>${sanitize(data.children[id].name)}</span>
                <button style="background:none; color:#2c3e50; font-size:1.4em; padding:0; margin:0;" onclick="showSettingsModal('${id}')">‚öôÔ∏è</button>
            </h3>
            <div style="font-size: 0.9em; color: #777;">
                Cost/zi: GrƒÉdini»õƒÉ (${data.children[id].defaultRate || 0}), ${sanitize(data.children[id].extraName)} (${data.children[id].defaultExtraRate || 0})
            </div>
            <div style="margin-top: 10px;">
                <strong>Zile GrƒÉdini»õƒÉ:</strong> ${daysKindergarten} (${totalKindergarten.toFixed(2)} lei)
            </div>
            <div>
                <strong>Zile ${sanitize(data.children[id].extraName)}:</strong> ${daysExtra} (${totalExtra.toFixed(2)} lei)
            </div>
            <div style="margin-top: 10px; font-weight: bold;">
                Total calculat: ${totalCalculated.toFixed(2)} lei
            </div>
            <div>
                PlƒÉtit GrƒÉdini»õƒÉ: <a href="#" onclick="showPaymentsModal('${id}')" style="text-decoration:none;">${totalPaidKindergarten.toFixed(2)} lei</a>
            </div>
            <div>
                PlƒÉtit ${sanitize(data.children[id].extraName)}: <a href="#" onclick="showPaymentsModal('${id}')" style="text-decoration:none;">${totalPaidExtra.toFixed(2)} lei</a>
            </div>
            <div style="font-weight: bold; color: ${diff >= 0 ? '#e74c3c' : '#2ecc71'};">
                Diferen»õƒÉ: ${diff.toFixed(2)} lei
            </div>
        `;
        container.appendChild(div);
    }
};


/* ================== Child Management (Modals) ================== */
const addChild = () => {
    const data = loadData();
    const newId = `c${Date.now()}`;
    const newChild = {
        name: `Copil Nou ${Object.keys(data.children).length + 1}`,
        defaultRate: 15,
        defaultExtraRate: 20,
        extraName: 'EnglezƒÉ',
        color: getRandomColor(),
        extraColor: getRandomColor()
    };
    data.children[newId] = newChild;
    saveData(data);
    renderCalendar();
};

const getRandomColor = () => {
    const letters = '0123456789ABCDEF';
    let color = '#';
    for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
};

const showSettingsModal = (childId) => {
    selectedChildIdForModal = childId;
    const data = loadData();
    const child = data.children[childId];
    document.getElementById('settingsChildName').textContent = sanitize(child.name);
    document.getElementById('editChildName').value = sanitize(child.name);
    document.getElementById('editDefaultRate').value = child.defaultRate;
    document.getElementById('editDefaultExtraRate').value = child.defaultExtraRate;
    document.getElementById('editChildColor').value = child.color || '#3498db';
    document.getElementById('editExtraName').value = child.extraName || 'EnglezƒÉ';
    document.getElementById('editExtraColor').value = child.extraColor || '#9b59b6';
    openModal('settingsModal');
};

const saveChildSettings = () => {
    const data = loadData();
    const childId = selectedChildIdForModal;
    if (!data.children[childId]) return;
    data.children[childId].name = sanitize(document.getElementById('editChildName').value.trim());
    data.children[childId].defaultRate = parseFloat(document.getElementById('editDefaultRate').value) || 0;
    data.children[childId].defaultExtraRate = parseFloat(document.getElementById('editDefaultExtraRate').value) || 0;
    data.children[childId].color = document.getElementById('editChildColor').value;
    data.children[childId].extraName = sanitize(document.getElementById('editExtraName').value.trim());
    data.children[childId].extraColor = document.getElementById('editExtraColor').value;
    saveData(data);
    renderCalendar();
    closeModal('settingsModal');
};

const deleteChild = () => {
    if (!confirm('»òtergi definitiv copilul »ôi toate datele aferente pentru el?')) return;
    const data = loadData();
    const id = selectedChildIdForModal;
    if (data.children && data.children[id]) delete data.children[id];
    for (const k of Object.keys(data)) {
        if (k === 'children') continue;
        if (data[k].days && data[k].days[id]) delete data[k].days[id];
        if (data[k].daysExtra && data[k].daysExtra[id]) delete data[k].daysExtra[id];
        if (data[k].rates && data[k].rates[id]) delete data[k].rates[id];
        if (data[k].extraRates && data[k].extraRates[id]) delete data[k].extraRates[id];
        if (data[k].payments && data[k].payments[id]) delete data[k].payments[id];
    }
    saveData(data);
    renderCalendar();
    closeModal('settingsModal');
};


/* ================== Payments Modal ================== */
const showPaymentsModal = (childId) => {
    selectedChildIdForModal = childId;
    const data = loadData();
    const key = `${year}-${month}`;
    const childName = data.children[childId].name;
    const monthName = new Date(year, month).toLocaleString('ro-RO', { month: 'long' });
    document.getElementById('paymentsChildName').textContent = sanitize(childName);
    document.getElementById('paymentsMonth').textContent = monthName;
    renderPaymentList();
    openModal('paymentsModal');
};

const renderPaymentList = () => {
    const data = loadData();
    const key = `${year}-${month}`;
    const childId = selectedChildIdForModal;
    const paymentList = document.getElementById('paymentList');
    paymentList.innerHTML = '';

    if (!data[key].payments[childId]) {
        data[key].payments[childId] = [];
    }

    let totalPaid = 0;
    data[key].payments[childId].sort((a,b) => new Date(a.date) - new Date(b.date));

    data[key].payments[childId].forEach((payment, index) => {
        totalPaid += parseFloat(payment.amount);
        const li = document.createElement('li');
        li.innerHTML = `
            <span>${payment.date} - ${parseFloat(payment.amount).toFixed(2)} lei (${payment.type === 'kindergarten' ? 'GrƒÉdini»õƒÉ' : data.children[childId].extraName})</span>
            <button onclick="deletePayment('${childId}', ${index})">&times;</button>
        `;
        paymentList.appendChild(li);
    });

    document.getElementById('paymentsTotal').textContent = totalPaid.toFixed(2);
};

const addPayment = () => {
    const data = loadData();
    const key = `${year}-${month}`;
    const childId = selectedChildIdForModal;
    const amount = parseFloat(document.getElementById('newPaymentAmount').value);
    const dateStr = document.getElementById('newPaymentDate').value;
    const type = document.getElementById('newPaymentType').value;

    if (isNaN(amount) || amount <= 0 || !dateStr) {
        alert("Introduce»õi o sumƒÉ »ôi o datƒÉ valide.");
        return;
    }

    const date = new Date(dateStr);
    const day = date.getDate();

    if (!data[key].payments[childId]) {
        data[key].payments[childId] = [];
    }

    // PreluƒÉm culoarea aleasƒÉ de utilizator din c√¢mpul de input color
    const paymentColor = document.getElementById('newPaymentColor').value;

    // AdaugƒÉm plata cu culoarea specificatƒÉ
    data[key].payments[childId].push({ amount: amount, date: dateStr, type: type, color: paymentColor });

    // AdaugƒÉ plata »ôi la `paymentsOnDay` pentru afi»ôare pe calendar
    if(!data[key].paymentsOnDay) data[key].paymentsOnDay = {};
    if(!data[key].paymentsOnDay[day]) data[key].paymentsOnDay[day] = [];

    // Folosim culoarea aleasƒÉ pentru indicatorul de pe calendar
    data[key].paymentsOnDay[day].push({ childId: childId, amount: amount, color: paymentColor });

    saveData(data);
    document.getElementById('newPaymentAmount').value = '';
    document.getElementById('newPaymentDate').value = '';
    renderPaymentList();
    renderChildrenReports();
    renderCalendar(); // Re-render calendar pentru a afisa plata
};

const deletePayment = (childId, index) => {
    const data = loadData();
    const key = `${year}-${month}`;
    if (confirm('E»ôti sigur cƒÉ vrei sƒÉ »ôtergi aceastƒÉ platƒÉ?')) {
        // Ob»õine informa»õiile plƒÉ»õii pentru a o »ôterge »ôi din paymentsOnDay
        const paymentToDelete = data[key].payments[childId][index];
        const date = new Date(paymentToDelete.date);
        const day = date.getDate();

        data[key].payments[childId].splice(index, 1);

        // »òterge din paymentsOnDay
        if(data[key].paymentsOnDay && data[key].paymentsOnDay[day]) {
            // Trebuie sƒÉ comparƒÉm »ôi culoarea/tipul/suma exactƒÉ, deoarece o zi poate avea mai multe plƒÉ»õi
            data[key].paymentsOnDay[day] = data[key].paymentsOnDay[day].filter(p => !(p.childId === childId && p.amount === paymentToDelete.amount && p.color === paymentToDelete.color));
            if(data[key].paymentsOnDay[day].length === 0) {
                delete data[key].paymentsOnDay[day];
            }
        }

        saveData(data);
        renderPaymentList();
        renderChildrenReports();
        renderCalendar(); // Re-render calendar pentru a actualiza afisarea
    }
};


/* ================== EXPORT / IMPORT ================== */
const exportJSON = () => {
    const data = loadData();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `gradinita_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
};

const importJSON = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const obj = JSON.parse(e.target.result);
            saveData(obj);
            alert('Import finalizat. Datele locale au fost √Ænlocuite.');
            renderCalendar();
        } catch (err) {
            alert('Fi»ôier JSON invalid.');
        }
    };
    reader.readAsText(file);
    event.target.value = '';
};

const exportExcel = () => {
  const data = loadData();
  const rows = [];
  for(const key of Object.keys(data)){
    if(key === 'children') continue;
    const [y, m] = key.split('-');
    const monthName = new Date(y, m).toLocaleString('ro-RO', { month: 'long' });
    for(const childId of Object.keys(data.children || {})){
      const kindergartenDays = (data[key].days && data[key].days[childId]) ? data[key].days[childId].length : 0;
      const kindergartenRate = (data[key].rates && data[key].rates[childId]) ? data[key].rates[childId] : (data.children[childId]?.defaultRate || 0);
      const extraDays = (data[key].daysExtra && data[key].daysExtra[childId]) ? data[key].daysExtra[childId].length : 0;
      const extraRate = (data[key].extraRates && data[key].extraRates[childId]) ? data[key].extraRates[childId] : (data.children[childId]?.defaultExtraRate || 0);
      const totalKindergarten = kindergartenDays * kindergartenRate;
      const totalExtra = extraDays * extraRate;
      const totalPaidKindergarten = (data[key].payments[childId] || []).filter(p => p.type === 'kindergarten').reduce((sum, p) => sum + parseFloat(p.amount), 0);
      const totalPaidExtra = (data[key].payments[childId] || []).filter(p => p.type === 'extra').reduce((sum, p) => sum + parseFloat(p.amount), 0);
      const totalPaid = totalPaidKindergarten + totalPaidExtra;
      const diff = (totalKindergarten + totalExtra) - totalPaid;

      rows.push({
        An: y,
        Luna: monthName,
        Copil: data.children[childId].name,
        "Zile GrƒÉdini»õƒÉ": kindergartenDays,
        "Cost/zi GrƒÉdini»õƒÉ": kindergartenRate,
        "Total GrƒÉdini»õƒÉ": totalKindergarten,
        ["Zile " + data.children[childId].extraName]: extraDays,
        ["Cost/zi " + data.children[childId].extraName]: extraRate,
        ["Total " + data.children[childId].extraName]: totalExtra,
        "Total Calculat": totalKindergarten + totalExtra,
        "PlƒÉtit GrƒÉdini»õƒÉ": totalPaidKindergarten,
        "PlƒÉtit Activitate": totalPaidExtra,
        "Total PlƒÉtit": totalPaid,
        "Diferenta": diff
      });
    }
  }

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Prezen»õe');
  XLSX.writeFile(wb, 'gradinita_export.xlsx');
};

const exportPDF = () => {
    const data = loadData();
    const rows = [];
    for(const key of Object.keys(data)){
        if(key === 'children') continue;
        const [y, m] = key.split('-');
        const monthName = new Date(y, m).toLocaleString('ro-RO', { month: 'long' });
        for(const childId of Object.keys(data.children || {})){
            const kindergartenDays = (data[key].days && data[key].days[childId]) ? data[key].days[childId].length : 0;
            const kindergartenRate = (data[key].rates && data[key].rates[childId]) ? data[key].rates[childId] : (data.children[childId]?.defaultRate || 0);
            const extraDays = (data[key].daysExtra && data[key].daysExtra[childId]) ? data[key].daysExtra[childId].length : 0;
            const extraRate = (data[key].extraRates && data[key].extraRates[childId]) ? data[key].extraRates[childId] : (data.children[childId]?.defaultExtraRate || 0);
            const totalKindergarten = kindergartenDays * kindergartenRate;
            const totalExtra = extraDays * extraRate;
            const totalPaidKindergarten = (data[key].payments[childId] || []).filter(p => p.type === 'kindergarten').reduce((sum, p) => sum + parseFloat(p.amount), 0);
            const totalPaidExtra = (data[key].payments[childId] || []).filter(p => p.type === 'extra').reduce((sum, p) => sum + parseFloat(p.amount), 0);
            const totalPaid = totalPaidKindergarten + totalPaidExtra;
            const diff = (totalKindergarten + totalExtra) - totalPaid;

            rows.push([
                y, monthName, data.children[childId].name,
                kindergartenDays, kindergartenRate, totalKindergarten,
                extraDays, extraRate, totalExtra,
                totalKindergarten + totalExtra, totalPaidKindergarten, totalPaidExtra, totalPaid, diff
            ]);
        }
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'pt', 'a4');
    const head = [['An','Luna','Copil','Zile GrƒÉd.','Cost/zi','Total GrƒÉd.','Zile Ext.','Cost/zi','Total Ext.','Total Calc.','PlƒÉtit GrƒÉd.','PlƒÉtit Ext.','Total PlƒÉtit','Diferen»õƒÉ']];
    doc.autoTable({
        head: head,
        body: rows,
        startY: 40,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [52,152,219], textColor: 255 },
        theme: 'grid'
    });
    doc.save('gradinita_export.pdf');
};


/* ================== Resetare date ================== */
const resetData = () => {
    if (!confirm('Sigur vrei sƒÉ »ôtergi toate datele stocate local? AceastƒÉ ac»õiune nu se poate anula.')) return;
    localStorage.removeItem(STORAGE_KEY);
    renderCalendar();
};

/* ================== Navigare lunƒÉ / an ================== */
const changeMonth = (offset) => {
    month += offset;
    if (month < 0) { month = 11; year -= 1; }
    if (month > 11) { month = 0; year += 1; }
    today = new Date(year, month, 1);
    document.getElementById('yearSelectNav').value = year;
    document.getElementById('monthSelectNav').value = month;
    renderCalendar();
};

const changeMonthToSelected = () => {
    month = parseInt(document.getElementById('monthSelectNav').value);
    year = parseInt(document.getElementById('yearSelectNav').value);
    renderCalendar();
};

/* ================== LegendƒÉ culori ================== */
const renderLegend = () => {
    const data = loadData();
    const legend = document.getElementById('legend');
    legend.innerHTML = '';
    if (!data.children) data.children = {};

    for (const childId of Object.keys(data.children)) {
        const child = data.children[childId];

        // Element pentru GrƒÉdini»õƒÉ
        const itemKindergarten = document.createElement('div');
        itemKindergarten.className = 'legend-item';
        const boxKindergarten = document.createElement('div');
        boxKindergarten.className = 'color-box';
        boxKindergarten.style.background = child.color;
        const labelKindergarten = document.createElement('div');
        labelKindergarten.textContent = `${sanitize(child.name)} - GrƒÉdini»õƒÉ`;
        itemKindergarten.appendChild(boxKindergarten);
        itemKindergarten.appendChild(labelKindergarten);
        legend.appendChild(itemKindergarten);

        // Element pentru Activitate SuplimentarƒÉ
        const itemExtra = document.createElement('div');
        itemExtra.className = 'legend-item';
        const boxExtra = document.createElement('div');
        boxExtra.className = 'color-box';
        boxExtra.style.background = child.extraColor;
        const labelExtra = document.createElement('div');
        labelExtra.textContent = `${sanitize(child.name)} - ${sanitize(child.extraName)}`;
        itemExtra.appendChild(boxExtra);
        itemExtra.appendChild(labelExtra);
        legend.appendChild(itemExtra);
    }

    // AdaugƒÉ legenda pentru plƒÉ»õi (folosim o culoare genericƒÉ, dar plata afi»ôatƒÉ pe calendar va folosi culoarea aleasƒÉ)
    const itemPayment = document.createElement('div');
    itemPayment.className = 'legend-item';
    const boxPayment = document.createElement('div');
    boxPayment.className = 'color-box';
    boxPayment.style.background = '#2ecc71';
    const labelPayment = document.createElement('div');
    labelPayment.textContent = 'Indicator PlatƒÉ';
    itemPayment.appendChild(boxPayment);
    itemPayment.appendChild(labelPayment);
    legend.appendChild(itemPayment);
};

/* ================== Grafic ================== */
const renderChart = () => {
    const data = loadData();
    const key = `${year}-${month}`;
    const children = data.children || {};
    const labels = [];
    const kindergartenData = [];
    const extraData = [];

    for (const id of Object.keys(children)) {
        const kindergartenDays = (data[key].days && data[key].days[id]) ? data[key].days[id].length : 0;
        const extraDays = (data[key].daysExtra && data[key].daysExtra[id]) ? data[key].daysExtra[id].length : 0;
        labels.push(children[id].name);
        kindergartenData.push(kindergartenDays);
        extraData.push(extraDays);
    }

    const ctx = document.getElementById('myChart').getContext('2d');
    if (chartInstance) {
        chartInstance.destroy();
    }

    chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Zile GrƒÉdini»õƒÉ',
                    data: kindergartenData,
                    backgroundColor: Object.values(children).map(c => c.color || '#3498db'),
                    borderColor: Object.values(children).map(c => c.color || '#3498db'),
                    borderWidth: 1
                },
                {
                    label: Object.values(children).length > 0 ? `Zile ${Object.values(children)[0].extraName}` : 'Zile Activitate SuplimentarƒÉ',
                    data: extraData,
                    backgroundColor: Object.values(children).map(c => c.extraColor || '#9b59b6'),
                    borderColor: Object.values(children).map(c => c.extraColor || '#9b59b6'),
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true, title: { display: true, text: 'NumƒÉr de zile' } }
            },
            plugins: {
                title: { display: true, text: `Prezen»õa copiilor √Æn luna ${new Date(year, month).toLocaleString('ro-RO', { month: 'long' })}` }
            }
        }
    });
};

/* ================== Raport general ================== */
const showGeneralReportModal = () => {
    const reportYearSelect = document.getElementById('reportYearSelect');
    reportYearSelect.innerHTML = '';
    const currentYear = new Date().getFullYear();
    for (let i = currentYear - 5; i <= currentYear + 5; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        reportYearSelect.appendChild(option);
    }
    reportYearSelect.value = currentYear;

    openModal('generalReportModal');
    // GenerƒÉm raportul ini»õial
    generateGeneralReport();
};

const generateGeneralReport = () => {
    const container = document.getElementById('generalReportContainer');
    container.innerHTML = '<h4>Se genereazƒÉ raportul...</h4>';

    const selectedYear = document.getElementById('reportYearSelect').value;
    const selectedMonth = document.getElementById('reportMonthSelect').value;
    const data = loadData();

    let monthsToReport = [];
    if (selectedMonth === '-1') {
        // Toate lunile din anul selectat
        for (let m = 0; m < 12; m++) {
            monthsToReport.push(`${selectedYear}-${m}`);
        }
    } else {
        monthsToReport.push(`${selectedYear}-${selectedMonth}`);
    }

    let reportHTML = '<table id="generalReportTable"><thead><tr><th>An</th><th>LunƒÉ</th><th>Copil</th><th>Total GrƒÉdini»õƒÉ (lei)</th><th>Total Activitate (lei)</th><th>Total Calculat (lei)</th><th>PlƒÉtit GrƒÉdini»õƒÉ (lei)</th><th>PlƒÉtit Activitate (lei)</th><th>Diferen»õƒÉ (lei)</th></tr></thead><tbody>';

    for (const key of monthsToReport) {
        if (!data[key]) continue;
        const [y, m] = key.split('-');
        const monthName = new Date(y, m).toLocaleString('ro-RO', { month: 'long' });

        for (const childId of Object.keys(data.children || {})) {
            const childData = data.children[childId];
            const monthData = data[key];

            const daysKindergarten = (monthData.days[childId] || []).length;
            const daysExtra = (monthData.daysExtra[childId] || []).length;
            const rateKindergarten = (monthData.rates[childId] !== undefined) ? monthData.rates[childId] : (childData.defaultRate || 0);
            const rateExtra = (monthData.extraRates[childId] !== undefined) ? monthData.extraRates[childId] : (childData.defaultExtraRate || 0);

            const totalKindergarten = daysKindergarten * rateKindergarten;
            const totalExtra = daysExtra * rateExtra;
            const totalCalculated = totalKindergarten + totalExtra;

            const totalPaidKindergarten = (monthData.payments[childId] || []).filter(p => p.type === 'kindergarten').reduce((sum, p) => sum + parseFloat(p.amount), 0);
            const totalPaidExtra = (monthData.payments[childId] || []).filter(p => p.type === 'extra').reduce((sum, p) => sum + parseFloat(p.amount), 0);
            const totalPaid = totalPaidKindergarten + totalPaidExtra;

            const diff = totalCalculated - totalPaid;

            reportHTML += `
                <tr>
                    <td>${y}</td>
                    <td>${monthName}</td>
                    <td>${sanitize(childData.name)}</td>
                    <td>${totalKindergarten.toFixed(2)}</td>
                    <td>${totalExtra.toFixed(2)}</td>
                    <td>${totalCalculated.toFixed(2)}</td>
                    <td>${totalPaidKindergarten.toFixed(2)}</td>
                    <td>${totalPaidExtra.toFixed(2)}</td>
                    <td style="color: ${diff >= 0 ? '#e74c3c' : '#2ecc71'};">${diff.toFixed(2)}</td>
                </tr>
            `;
        }
    }

    reportHTML += '</tbody></table>';
    container.innerHTML = reportHTML;
};


/* ================== Backup automat ================== */
const autoBackup = () => {
    const now = Date.now();
    const lastBackup = localStorage.getItem('lastBackupTime');
    if (!lastBackup || (now - lastBackup > BACKUP_INTERVAL_MS)) {
        exportJSON();
        localStorage.setItem('lastBackupTime', now);
        console.log("Auto-backup completed.");
    }
};

/* ================== Ini»õializare ================== */
(function init() {
    const data = loadData();
    if (!data.children || Object.keys(data.children).length === 0) {
        data.children = {};
        const id1 = 'c1';
        const id2 = 'c2';
        data.children[id1] = { name: 'Casian', defaultRate: 15, defaultExtraRate: 20, extraName: 'EnglezƒÉ', color: '#4da6ff', extraColor: '#9b59b6' };
        data.children[id2] = { name: 'Ezra', defaultRate: 15, defaultExtraRate: 20, extraName: 'EnglezƒÉ', color: '#ffd633', extraColor: '#ff6f61' };
        saveData(data);
    }
    // Update old data structure to V5 if it exists and is old
    if (localStorage.getItem('gradinitaDataV4') !== null) {
        localStorage.removeItem('gradinitaDataV4');
        console.log("Previous data structure V4 reset to V5.");
    }

    document.getElementById('yearSelectNav').value = new Date().getFullYear();
    document.getElementById('monthSelectNav').value = new Date().getMonth();

    renderCalendar();
    // autoBackup();
    // setInterval(autoBackup, BACKUP_INTERVAL_MS);
    // ================== PWA Service Worker Registration ==================
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            })
            .catch(error => {
                console.log('ServiceWorker registration failed: ', error);
            });
    });
}
})();
</script>
</body>
</html>
