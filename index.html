<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PrezenÈ›Äƒ GrÄƒdiniÈ›Äƒ</title>

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="application-name" content="GrÄƒdiniÈ›Äƒ">
<meta name="apple-mobile-web-app-title" content="GrÄƒdiniÈ›Äƒ">
<meta name="theme-color" content="#3498db">
<meta name="msapplication-navbutton-color" content="#3498db">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="msapplication-starturl" content="/index.html">

<link rel="icon" type="image/png" sizes="192x192" href="https://via.placeholder.com/192.png?text=G">
<link rel="apple-touch-icon" type="image/png" sizes="192x192" href="https://via.placeholder.com/192.png?text=G">

<link rel="manifest" href="manifest.json">

<style>
/* --- Layout general --- */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  padding: 0;
  background: #f0f4f7;
  color: #333;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
}

/* Container central care Ã®ncadrÄƒ tot conÈ›inutul */
.container {
  max-width: 1100px;
  width: 95%;
  background: #fff;
  margin: 20px;
  padding: 24px;
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.1);
}

/* Titlu */
h1 {
  text-align: center;
  color: #2c3e50;
  margin-top: 0;
  font-size: 2.2em;
}
h2 {
    font-size: 1.4em;
    color: #34495e;
    border-bottom: 2px solid #ecf0f1;
    padding-bottom: 8px;
    margin-top: 24px;
}

/* Butoane */
button {
  padding: 10px 18px;
  margin: 6px 4px;
  cursor: pointer;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  background: #3498db;
  color: white;
  transition: background-color 0.2s, transform 0.1s;
}
button:hover { background: #2980b9; transform: translateY(-1px); }
.button-group { display: flex; flex-wrap: wrap; justify-content: center; margin-bottom: 12px; }

/* Calendar - grid 7 coloane */
.calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  margin: 16px 0 20px 0;
}
.day {
  border-radius: 10px;
  min-height: 55px;
  text-align: center;
  border: 1px solid #ddd;
  cursor: pointer;
  user-select: none;
  font-size: 15px;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  line-height: 1.3;
  transition: background-color 0.3s, transform 0.1s;
}
.day:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.day .day-number { font-size: 15px; margin-top: 6px; font-weight: bold; }
.day-header {
  font-weight: 700;
  background: #ecf0f1;
  border-radius: 10px;
  padding: 8px 0;
  text-align: center;
}
.day.weekend { color: #888; }
.day.holiday { background-color: #e8f4fb; border-color: #bce0f6; }

/* Indicatori activitate zilnicÄƒ */
.day .indicators {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 3px;
  margin-top: 4px;
  margin-bottom: 4px;
}
.day .indicators .indicator {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  border: 1px solid rgba(0,0,0,0.1);
}
.day.note-indicator::after {
    content: "ğŸ“";
    position: absolute;
    top: 4px;
    right: 4px;
    font-size: 10px;
}
/* Indicator pentru plata */
.day .payment-indicator::after {
    content: "ğŸ’µ";
    position: absolute;
    bottom: 4px;
    left: 4px;
    font-size: 12px;
}

/* Rapoarte copii */
.report {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  justify-content: center;
  margin-bottom: 24px;
}
.child-report {
  background: #f8f8f8;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  padding: 16px;
  min-width: 280px;
  box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
  font-size: 0.95em;
}
.child-report h3 {
  margin: 0 0 12px 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 1.2em;
}
.child-report h3 span { font-weight: bold; }

/* Inputs */
input[type="number"], input[type="text"], select {
  width: 95%;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin: 6px 0;
  box-sizing: border-box;
}

/* Popup (modals) */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
  backdrop-filter: blur(4px);
  justify-content: center;
  align-items: center;
}
.modal-content {
  background-color: #fff;
  padding: 24px;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  max-width: 500px;
  width: 90%;
  position: relative;
  animation: modal-fadein 0.3s ease-out;
}
.modal-close {
  color: #aaa;
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}
.modal-close:hover, .modal-close:focus { color: #000; text-decoration: none; }
@keyframes modal-fadein { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

/* Stiluri specifice pentru popup */
.day-popup-section {
  border-bottom: 1px solid #eee;
  padding-bottom: 10px;
  margin-bottom: 10px;
}
.day-popup-section h4 { margin: 0 0 10px 0; font-size: 1.1em; }
.day-popup-section button.active {
    background: #2ecc71;
    color: white;
    border-color: #2ecc71;
}

/* LegendÄƒ culori */
.legend {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  justify-content: center;
  margin-top: 20px;
  padding: 12px;
  background: #f8f8f8;
  border-radius: 12px;
  border: 1px solid #eee;
}
.legend-item { display: flex; gap: 8px; align-items: center; font-size: 14px; }
.color-box { width: 20px; height: 20px; border-radius: 6px; border: 1px solid rgba(0,0,0,0.08); }

/* Detalii contabile */
.accounting-section {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    justify-content: center;
    margin-top: 24px;
}
.payment-history {
    background: #f8f8f8;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 16px;
    flex: 1;
    min-width: 300px;
    box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
}
.payment-list { list-style-type: none; padding: 0; }
.payment-list li {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 8px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.payment-list li button {
    background: none;
    border: none;
    color: #e74c3c;
    font-size: 1.2em;
    padding: 0;
    margin: 0;
}
.payment-input-group { display: flex; gap: 8px; }

/* Grafice */
#chartContainer {
    max-width: 600px;
    margin: 20px auto;
    background: #f8f8f8;
    padding: 15px;
    border-radius: 12px;
    border: 1px solid #e0e0e0;
}

/* Stiluri pentru raportul general */
#generalReportContainer {
    margin-top: 20px;
    max-height: 60vh;
    overflow-y: auto;
}
#generalReportTable {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}
#generalReportTable th, #generalReportTable td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}
#generalReportTable th {
    background-color: #3498db;
    color: white;
    position: sticky;
    top: 0;
}
#generalReportTable tr:nth-child(even) { background-color: #f2f2f2; }
.report-options {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    margin-bottom: 15px;
}

@media (max-width:768px) {
  .day { min-height:48px; }
  .day-header { padding: 6px 0; }
  button { width:100%; margin: 6px 0; }
  .child-report { min-width:unset; width:100%; }
  .container { padding:16px; margin:10px; }
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="flex:1;"></div>
        <h1>PrezenÈ›Äƒ GrÄƒdiniÈ›Äƒ</h1>
        <div style="flex:1; text-align:right;">
            <button style="padding: 8px 12px; margin: 0; background: #95a5a6;" onclick="window.open('https://github.com/Aswy13/gradinita', '_blank')">INFO</button>
        </div>
    </div>

  <div style="text-align:center; margin-bottom:12px; display:flex; align-items:center; justify-content:center; gap:8px;">
    <button onclick="changeMonth(-1)">â¬…</button>
    <select id="monthSelectNav" onchange="changeMonthToSelected()">
        <option value="0">Ianuarie</option><option value="1">Februarie</option><option value="2">Martie</option>
        <option value="3">Aprilie</option><option value="4">Mai</option><option value="5">Iunie</option>
        <option value="6">Iulie</option><option value="7">August</option><option value="8">Septembrie</option>
        <option value="9">Octombrie</option><option value="10">Noiembrie</option><option value="11">Decembrie</option>
    </select>
    <input type="number" id="yearSelectNav" onchange="changeMonthToSelected()" value="" style="width:80px; text-align:center;" />
    <button onclick="changeMonth(1)">â¡</button>
  </div>

  <div id="calendar" class="calendar"></div>

  <div id="chartContainer">
      <canvas id="myChart"></canvas>
  </div>

  <div class="report" id="childrenReports"></div>

  <div class="button-group">
    <button onclick="addChild()">â• AdaugÄƒ copil</button>
    <button onclick="resetData()">ğŸ—‘ï¸ Resetare date</button>
    <button onclick="exportJSON()">ğŸ’¾ Export JSON</button>
    <input type="file" id="importFile" style="display:none" accept=".json" onchange="importJSON(event)">
    <button onclick="document.getElementById('importFile').click()">ğŸ“‚ Import JSON</button>
  </div>

  <div class="button-group">
    <button onclick="exportExcel()">ğŸ“Š Export Excel</button>
    <button onclick="exportPDF()">ğŸ“„ Export PDF</button>
    <button onclick="showGeneralReportModal()">ğŸ“ˆ Generare Raport General</button>
  </div>

  <div class="legend" id="legend"></div>
    <div style="text-align: center; margin-top: 20px; color: #7f8c8d; font-size: 0.9em;">
        AplicaÈ›ie creatÄƒ de Aswy
    </div>
</div>

<div id="dayModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('dayModal')">&times;</span>
        <h3 style="text-align: center;">Detalii pentru ziua <span id="modalDayNumber"></span></h3>

        <div class="day-popup-section">
            <h4>PrezenÈ›Äƒ È™i activitÄƒÈ›i</h4>
            <div id="childSelectionButtons"></div>
        </div>

        <div class="day-popup-section">
            <h4>NotiÈ›e</h4>
            <textarea id="noteTextarea" placeholder="AdaugÄƒ o notiÈ›Äƒ (ex: schemÄƒ de mÃ¢ncare, observaÈ›ie)..." style="width: 100%; height: 80px;"></textarea>
            <button onclick="saveNote()">SalveazÄƒ notiÈ›a</button>
        </div>

        <div style="display: flex; justify-content: space-between; gap: 8px;">
            <button style="background-color: #e74c3c; width: 100%;" onclick="clearDaySelections()">È˜terge toate selecÈ›iile</button>
            <button style="background-color: #3498db; width: 100%;" onclick="closeModal('dayModal')">Ãnchide</button>
        </div>
    </div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('settingsModal')">&times;</span>
        <h3>SetÄƒri pentru <span id="settingsChildName"></span></h3>
        <label>Nume copil:</label><br>
        <input type="text" id="editChildName" /><br>
        <label>Cost standard GrÄƒdiniÈ›Äƒ:</label><br>
        <input type="number" id="editDefaultRate" /><br>
        <label>Culoare GrÄƒdiniÈ›Äƒ:</label><br>
        <input type="color" id="editChildColor" /><br>
        <label>Nume activitate suplimentarÄƒ:</label><br>
        <input type="text" id="editExtraName" /><br>
        <label>Cost standard activitate:</label><br>
        <input type="number" id="editDefaultExtraRate" /><br>
        <label>Culoare activitate:</label><br>
        <input type="color" id="editExtraColor" /><br>
        <div style="display:flex; justify-content:space-between; margin-top:10px;">
            <button style="background: #e74c3c; flex: 1; margin: 0 4px;" onclick="deleteChild()">È˜terge copil</button>
            <button style="background: #2ecc71; flex: 1; margin: 0 4px;" onclick="saveChildSettings()">SalveazÄƒ</button>
        </div>
    </div>
</div>

<div id="paymentsModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('paymentsModal')">&times;</span>
        <h3>Istoric plÄƒÈ›i <span id="paymentsChildName"></span> (<span id="paymentsMonth"></span>)</h3>
        <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;">
            <div style="display: flex; gap: 8px;">
                <input type="number" id="newPaymentAmount" placeholder="SumÄƒ" style="flex: 1;"/>
                <input type="date" id="newPaymentDate" style="flex: 1;"/>
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
                <label>PlatÄƒ pentru:</label>
                <select id="newPaymentType" style="flex: 1;">
                    <option value="kindergarten">GrÄƒdiniÈ›Äƒ</option>
                    <option value="extra">Activitate SuplimentarÄƒ</option>
                </select>
                <label>Culoare platÄƒ:</label>
                <input type="color" id="newPaymentColor" value="#2ecc71" style="width: 50px;"/>
            </div>
            <button onclick="addPayment()">AdaugÄƒ platÄƒ</button>
        </div>
        <ul id="paymentList" class="payment-list"></ul>
        <div style="margin-top: 15px; font-weight: bold; font-size: 1.1em;">
            Total plÄƒtit: <span id="paymentsTotal">0</span>
        </div>
    </div>
</div>

<div id="generalReportModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <span class="modal-close" onclick="closeModal('generalReportModal')">&times;</span>
        <h3 style="text-align: center;">Raport General</h3>
        <div class="report-options">
            <label>An:</label>
            <select id="reportYearSelect"></select>
            <label>LunÄƒ (selectaÈ›i mai multe cu Ctrl/Cmd):</label>
            <select id="reportMonthSelect" multiple style="height: 150px;">
                <option value="-1">Toate lunile</option>
                <option value="0">Ianuarie</option><option value="1">Februarie</option><option value="2">Martie</option>
                <option value="3">Aprilie</option><option value="4">Mai</option><option value="5">Iunie</option>
                <option value="6">Iulie</option><option value="7">August</option><option value="8">Septembrie</option>
                <option value="9">Octombrie</option><option value="10">Noiembrie</option><option value="11">Decembrie</option>
            </select>
            <button onclick="generateGeneralReport()">GenereazÄƒ Raport</button>
        </div>
        <div id="generalReportContainer"></div>
    </div>
</div>

<script>
/* ================== VARIABILE & CONFIG ================== */
const STORAGE_KEY = 'gradinitaDataV5';
const BACKUP_INTERVAL_MS = 60 * 60 * 1000;
let lastBackupTime = 0;

let today = new Date();
let month = today.getMonth();
let year = today.getFullYear();
let selectedDays = [];
let selectedCell = null;
let chartInstance = null;
let selectedChildIdForModal = null;

/* ================== HELPER: load/save localStorage ================== */
const loadData = () => {
    try {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        if (!data.children || typeof data.children !== 'object') {
            data.children = {};
        }
        return data;
    } catch (e) {
        console.error("Failed to load data from localStorage", e);
        return { children: {} };
    }
};

const saveData = (data) => {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
        console.error("Failed to save data to localStorage", e);
    }
};

const sanitize = (input) => {
    if (typeof input !== 'string') return input;
    const temp = document.createElement('div');
    temp.textContent = input;
    return temp.innerHTML;
};

/* ================== RENDER: calendar + rapoarte ================== */
const renderCalendar = () => {
    const calendar = document.getElementById('calendar');
    calendar.innerHTML = '';
    const data = loadData();
    const key = `${year}-${month}`;

    if (!data[key]) {
        data[key] = {
            days: {},
            daysExtra: {},
            rates: {},
            notes: {},
            extraRates: {},
            payments: {},
            holidays: [],
            paymentsOnDay: {}
        };
        saveData(data);
    }

    const weekdays = ['Lu', 'Ma', 'Mi', 'Jo', 'Vi', 'Sa', 'Du'];
    weekdays.forEach((w, idx) => {
        const el = document.createElement('div');
        el.className = 'day-header';
        if (idx >= 5) el.classList.add('weekend');
        el.textContent = w;
        calendar.appendChild(el);
    });

    const firstDay = new Date(year, month, 1).getDay();
    const empty = firstDay === 0 ? 6 : firstDay - 1;
    for (let i = 0; i < empty; i++) calendar.appendChild(document.createElement('div'));

    const daysInMonth = new Date(year, month + 1, 0).getDate();
    for (let d = 1; d <= daysInMonth; d++) {
        const day = document.createElement('div');
        day.className = 'day';
        day.dataset.day = d;
        day.innerHTML = `<span class="day-number">${d}</span>`;
        if (new Date(year, month, d).getDay() === 0 || new Date(year, month, d).getDay() === 6) {
            const key = `${year}-${month}`;
            if (!data[key].holidays.includes(d)) data[key].holidays.push(d);
            saveData(data);
            day.classList.add('weekend');
        }
        day.onclick = (e) => toggleCtrlSelection(d, day, e);
        updateDayDisplay(day, d, data[key]);
        calendar.appendChild(day);
    }

    const monthLabelNav = document.getElementById('monthSelectNav');
    const yearLabelNav = document.getElementById('yearSelectNav');
    monthLabelNav.value = month;
    yearLabelNav.value = year;

    renderChildrenReports();
    renderLegend();
    renderChart();
};

const updateDayDisplay = (cell, day, monthData) => {
    cell.style.backgroundColor = '';
    cell.style.color = '#333';
    cell.style.border = '1px solid #ddd';
    cell.style.background = '';
    cell.classList.remove('note-indicator', 'payment-indicator');

    let indicators = cell.querySelector('.indicators');
    if(indicators) indicators.remove();
    indicators = document.createElement('div');
    indicators.className = 'indicators';

    if (!monthData) return;

    if(monthData.notes && monthData.notes[day]){
        cell.classList.add('note-indicator');
    }

    if(monthData.holidays && monthData.holidays.includes(day)){
        cell.classList.add('holiday');
        return;
    }

    const childrenData = loadData().children;
    const paymentIndicators = [];

    // VerificÄƒ prezenÈ›ele
    for (const childId of Object.keys(childrenData)) {
        if (monthData.days[childId] && monthData.days[childId].includes(day)) {
            const indicator = document.createElement('div');
            indicator.className = 'indicator';
            indicator.style.backgroundColor = childrenData[childId]?.color || '#3498db';
            indicators.appendChild(indicator);
        }
        if (monthData.daysExtra[childId] && monthData.daysExtra[childId].includes(day)) {
            const indicator = document.createElement('div');
            indicator.className = 'indicator';
            indicator.style.backgroundColor = childrenData[childId]?.extraColor || '#9b59b6';
            indicators.appendChild(indicator);
        }
    }

    // VerificÄƒ plÄƒÈ›ile pentru ziua respectivÄƒ
    if(monthData.paymentsOnDay && monthData.paymentsOnDay[day]) {
      const paymentInfo = monthData.paymentsOnDay[day];
      if(paymentInfo.length > 0) {
        const indicator = document.createElement('div');
        indicator.className = 'indicator';
        indicator.style.backgroundColor = paymentInfo[0].color;
        indicators.appendChild(indicator);
      }
    }

    if (indicators.children.length > 0) {
        cell.appendChild(indicators);
    }
};


/* ================== MODALS ================== */
const clearMultiSelection = () => {
    selectedDays.forEach(d => {
        const cell = document.querySelector(`.day[data-day='${d}']`);
        if (cell) cell.style.outline = '';
    });
    selectedDays = [];
};

const openModal = (modalId) => {
    const modal = document.getElementById(modalId);
    modal.style.display = 'flex';
};

const closeModal = (modalId) => {
    const modal = document.getElementById(modalId);
    modal.style.display = 'none';
    if(modalId === 'dayModal') {
        clearMultiSelection();
    }
};

const showDayModal = (day, elCell) => {
    // selectedDay is now implicitly the current selectedDays array
    document.getElementById('modalDayNumber').textContent = selectedDays.length > 1 ? selectedDays.join(', ') : day;
    const data = loadData();
    const key = `${year}-${month}`;
    const children = data.children || {};
    const childSelectionButtons = document.getElementById('childSelectionButtons');
    childSelectionButtons.innerHTML = '';

    const isHoliday = data[key].holidays && data[key].holidays.includes(day);
    const holidayBtn = document.createElement('button');
    // VerificÄƒ dacÄƒ toate zilele selectate sunt "holiday" pentru a determina starea butonului
    holidayBtn.textContent = selectedDays.every(d => data[key].holidays && data[key].holidays.includes(d)) ? 'AnuleazÄƒ zi liberÄƒ' : 'MarcheazÄƒ ca zi liberÄƒ';
    holidayBtn.style.backgroundColor = selectedDays.every(d => data[key].holidays && data[key].holidays.includes(d)) ? '#e74c3c' : '#2ecc71';
    holidayBtn.onclick = applyMultiHoliday;
    childSelectionButtons.appendChild(holidayBtn);

    for (const id of Object.keys(children)) {
        // VerificÄƒ dacÄƒ toate zilele selectate au prezenÈ›a / extra activitatea marcatÄƒ
        const isKindergartenActive = selectedDays.every(d => data[key].days[id] && data[key].days[id].includes(d));
        const isExtraActive = selectedDays.every(d => data[key].daysExtra[id] && data[key].daysExtra[id].includes(d));

        const childSection = document.createElement('div');
        childSection.className = 'selection-buttons';
        childSection.innerHTML = `
            <span>${sanitize(children[id].name)}</span>
            <button class="${isKindergartenActive ? 'active' : ''}" onclick="applyMultiPresence('${id}','kindergarten')">GrÄƒdiniÈ›Äƒ</button>
            <button class="${isExtraActive ? 'active' : ''}" onclick="applyMultiPresence('${id}','extra')">${sanitize(children[id].extraName)}</button>
        `;
        childSelectionButtons.appendChild(childSection);
    }

    const existingNote = (data[key].notes && data[key].notes[selectedDays[0]]) || '';
    document.getElementById('noteTextarea').value = sanitize(existingNote);

    openModal('dayModal');
};

const saveNote = () => {
    const data = loadData();
    const key = `${year}-${month}`;
    if (!data[key].notes) data[key].notes = {};
    const note = document.getElementById('noteTextarea').value.trim();
    if (note) {
        selectedDays.forEach(d => {
            data[key].notes[d] = sanitize(note);
            const cell = document.querySelector(`.day[data-day='${d}']`);
            if (cell) updateDayDisplay(cell, d, data[key]);
        });
    } else {
        selectedDays.forEach(d => {
            delete data[key].notes[d];
            const cell = document.querySelector(`.day[data-day='${d}']`);
            if (cell) updateDayDisplay(cell, d, data[key]);
        });
    }
    saveData(data);
    closeModal('dayModal');
    clearMultiSelection();
};

const clearDaySelections = () => {
    const data = loadData();
    const key = `${year}-${month}`;
    selectedDays.forEach(d => {
        for (const childId in data.children) {
            if (data[key].days[childId]) {
                data[key].days[childId] = data[key].days[childId].filter(day => day !== d);
            }
            if (data[key].daysExtra[childId]) {
                data[key].daysExtra[childId] = data[key].daysExtra[childId].filter(day => day !== d);
            }
        }
        if (data[key].holidays) {
            data[key].holidays = data[key].holidays.filter(day => day !== d);
        }
        if (data[key].notes) {
            delete data[key].notes[d];
        }
    });
    saveData(data);
    renderCalendar();
    closeModal('dayModal');
    clearMultiSelection();
};


// ================== SELECÈšIE MULTIPLÄ‚ CU CTRL - LOGICÄ‚ CORECTATÄ‚ ==================
const toggleCtrlSelection = (day, elCell, event) => {
    const isCtrlKey = event.ctrlKey || event.metaKey;
    const index = selectedDays.indexOf(day);

    if (isCtrlKey) {
        // Ctrl Click: Toggle selection and outline. Do nothing else.
        if (index > -1) {
            selectedDays.splice(index, 1);
            elCell.style.outline = '';
        } else {
            selectedDays.push(day);
            elCell.style.outline = '3px solid #3498db';
        }
    } else {
        // Normal Click: Open modal for the current selection.

        // 1. Check if the click is on a day that is ALREADY part of a multi-selection
        const isOpeningMulti = selectedDays.length > 1 && index > -1;

        if (!isOpeningMulti) {
            // 2. If it's a new single-day click, clear previous selection and highlight only this day.
            clearMultiSelection(); // Clearing selection outline
            selectedDays = [day];
            elCell.style.outline = '3px solid #3498db';
        }

        // 3. Open the modal with the current selectedDays list.
        showDayModal(day, elCell);
    }
};

const applyMultiPresence = (childId, type) => {
    const data = loadData();
    const key = `${year}-${month}`;
    const daysField = type === 'kindergarten' ? 'days' : 'daysExtra';
    if (!data[key][daysField][childId]) data[key][daysField][childId] = [];

    // DeterminÄƒ dacÄƒ acÈ›iunea e de "on" sau "off" pe baza selecÈ›iei curente
    const isTogglingOn = !selectedDays.every(d => data[key][daysField][childId].includes(d));

    selectedDays.forEach(d => {
        const arr = data[key][daysField][childId];
        const idx = arr.indexOf(d);
        if (isTogglingOn) {
            if (idx === -1) {
                arr.push(d);
            }
            // Scoate de la "holidays" dacÄƒ se marcheazÄƒ prezenÈ›a
            if (data[key].holidays && data[key].holidays.includes(d)) {
                data[key].holidays = data[key].holidays.filter(h => h !== d);
            }
        } else {
            if (idx > -1) {
                arr.splice(idx, 1);
            }
        }
    });

    saveData(data);
    renderCalendar();
    closeModal('dayModal');
    clearMultiSelection();
};

const applyMultiHoliday = () => {
    const data = loadData();
    const key = `${year}-${month}`;
    if (!data[key].holidays) data[key].holidays = [];

    // DeterminÄƒ dacÄƒ acÈ›iunea e de "on" sau "off" pe baza selecÈ›iei curente
    const isTogglingOn = !selectedDays.every(d => data[key].holidays.includes(d));

    selectedDays.forEach(d => {
        const idx = data[key].holidays.indexOf(d);
        if (isTogglingOn) {
            if (idx === -1) {
                data[key].holidays.push(d);
            }
            // Scoate de la "prezenÈ›Äƒ" dacÄƒ se marcheazÄƒ zi liberÄƒ
            for(const childId in data.children){
                if (data[key].days[childId]) {
                    data[key].days[childId] = data[key].days[childId].filter(day => day !== d);
                }
                if (data[key].daysExtra[childId]) {
                    data[key].daysExtra[childId] = data[key].daysExtra[childId].filter(day => day !== d);
                }
            }
        } else {
            if (idx > -1) {
                data[key].holidays.splice(idx, 1);
            }
        }
    });

    saveData(data);
    renderCalendar();
    closeModal('dayModal');
    clearMultiSelection();
};

// MODIFICAT: Logica de calcul a fost inversatÄƒ (plÄƒtit - calculat) pentru a afiÈ™a soldul corect
/* ================== RENDER rapoarte per copil ================== */
const renderChildrenReports = () => {
    const container = document.getElementById('childrenReports');
    container.innerHTML = '';
    const data = loadData();
    if (!data.children) data.children = {};
    const key = `${year}-${month}`;
    if (!data[key]) data[key] = {
        days: {}, daysExtra: {}, rates: {}, notes: {}, extraRates: {}, payments: {}, holidays: [], paymentsOnDay: {}
    };

    let prevMonth = month - 1;
    let prevYear = year;
    if (prevMonth < 0) {
        prevMonth = 11;
        prevYear -= 1;
    }
    const prevKey = `${prevYear}-${prevMonth}`;
    const prevMonthData = data[prevKey];

    for (const id of Object.keys(data.children)) {
        if (!data[key].days[id]) data[key].days[id] = [];
        if (!data[key].daysExtra[id]) data[key].daysExtra[id] = [];
        if (!data[key].rates[id]) data[key].rates[id] = data.children[id].defaultRate || 15;
        if (!data[key].extraRates[id]) data[key].extraRates[id] = data.children[id].defaultExtraRate || 0;
        if (!data[key].payments[id]) data[key].payments[id] = [];

        const daysKindergarten = data[key].days[id].length;
        const daysExtra = data[key].daysExtra[id].length;
        const totalKindergarten = daysKindergarten * (data[key].rates[id] || 0);
        const totalExtra = daysExtra * (data[key].extraRates[id] || 0);
        const totalCalculatedCurrentMonth = totalKindergarten + totalExtra;

        const totalPaidKindergarten = data[key].payments[id].filter(p => p.type === 'kindergarten').reduce((sum, p) => sum + parseFloat(p.amount), 0);
        const totalPaidExtra = data[key].payments[id].filter(p => p.type === 'extra').reduce((sum, p) => sum + parseFloat(p.amount), 0);
        const totalPaidCurrentMonth = totalPaidKindergarten + totalPaidExtra;

        let previousMonthBalance = 0;
        if (prevMonthData && prevMonthData.days && prevMonthData.payments) {
            const prevDaysKindergarten = (prevMonthData.days[id] || []).length;
            const prevRateKindergarten = prevMonthData.rates?.[id] ?? data.children[id].defaultRate;
            const prevTotalKindergarten = prevDaysKindergarten * prevRateKindergarten;

            const prevDaysExtra = (prevMonthData.daysExtra[id] || []).length;
            const prevRateExtra = prevMonthData.extraRates?.[id] ?? data.children[id].defaultExtraRate;
            const prevTotalExtra = prevDaysExtra * prevRateExtra;

            const prevTotalCalculated = prevTotalKindergarten + prevTotalExtra;
            const prevTotalPaid = (prevMonthData.payments[id] || []).reduce((sum, p) => sum + parseFloat(p.amount), 0);

            // MODIFICAT: Logica inversatÄƒ: PlÄƒtit - Calculat
            previousMonthBalance = prevTotalPaid - prevTotalCalculated;
        }

        const totalToPayWithBalance = totalCalculatedCurrentMonth - previousMonthBalance;
        // MODIFICAT: Logica inversatÄƒ: PlÄƒtit - (Calculat - Sold)
        const finalDiff = totalPaidCurrentMonth - totalToPayWithBalance;

        const div = document.createElement('div');
        div.className = 'child-report';
        div.innerHTML = `
            <h3>
                <span>${sanitize(data.children[id].name)}</span>
                <button style="background:none; color:#2c3e50; font-size:1.4em; padding:0; margin:0;" onclick="showSettingsModal('${id}')">âš™ï¸</button>
            </h3>
            <div style="margin-top: 10px;">
                <strong>Zile GrÄƒdiniÈ›Äƒ:</strong> ${daysKindergarten} (${totalKindergarten.toFixed(2)} lei)
            </div>
            <div>
                <strong>Zile ${sanitize(data.children[id].extraName)}:</strong> ${daysExtra} (${totalExtra.toFixed(2)} lei)
            </div>
            <div style="border-top: 1px solid #eee; margin-top: 8px; padding-top: 8px;">
                <strong>Subtotal luna curentÄƒ:</strong> ${totalCalculatedCurrentMonth.toFixed(2)} lei
            </div>
            <div style="font-weight: bold; color: ${previousMonthBalance >= 0 ? '#2ecc71' : '#e74c3c'};">
                Sold lunÄƒ precedentÄƒ: ${previousMonthBalance.toFixed(2)} lei
            </div>
            <div style="margin-top: 10px; font-weight: bold; font-size: 1.1em; border-top: 1px solid #ddd; padding-top: 8px;">
                Total de platÄƒ (cu sold): ${totalToPayWithBalance.toFixed(2)} lei
            </div>
            <div>
                PlÄƒtit GrÄƒdiniÈ›Äƒ: <a href="#" onclick="showPaymentsModal('${id}')" style="text-decoration:none;">${totalPaidKindergarten.toFixed(2)} lei</a>
            </div>
            <div>
                PlÄƒtit ${sanitize(data.children[id].extraName)}: <a href="#" onclick="showPaymentsModal('${id}')" style="text-decoration:none;">${totalPaidExtra.toFixed(2)} lei</a>
            </div>
            <div style="font-weight: bold; font-size: 1.1em; color: ${finalDiff >= 0 ? '#2ecc71' : '#e74c3c'}; border-top: 1px solid #ddd; margin-top: 8px; padding-top: 8px;">
                BalanÈ›Äƒ finalÄƒ: ${finalDiff.toFixed(2)} lei
            </div>
        `;
        container.appendChild(div);
    }
};


/* ================== Child Management (Modals) ================== */
const addChild = () => {
    const data = loadData();
    const newId = `c${Date.now()}`;
    const newChild = {
        name: `Copil Nou ${Object.keys(data.children).length + 1}`,
        defaultRate: 15,
        defaultExtraRate: 20,
        extraName: 'EnglezÄƒ',
        color: getRandomColor(),
        extraColor: getRandomColor()
    };
    data.children[newId] = newChild;
    saveData(data);
    renderCalendar();
};

const getRandomColor = () => {
    const letters = '0123456789ABCDEF';
    let color = '#';
    for (let i = 0; i < 6; i++) {
        color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
};

const showSettingsModal = (childId) => {
    selectedChildIdForModal = childId;
    const data = loadData();
    const child = data.children[childId];
    document.getElementById('settingsChildName').textContent = sanitize(child.name);
    document.getElementById('editChildName').value = sanitize(child.name);
    document.getElementById('editDefaultRate').value = child.defaultRate;
    document.getElementById('editDefaultExtraRate').value = child.defaultExtraRate;
    document.getElementById('editChildColor').value = child.color || '#3498db';
    document.getElementById('editExtraName').value = child.extraName || 'EnglezÄƒ';
    document.getElementById('editExtraColor').value = child.extraColor || '#9b59b6';
    openModal('settingsModal');
};

const saveChildSettings = () => {
    const data = loadData();
    const childId = selectedChildIdForModal;
    if (!data.children[childId]) return;
    data.children[childId].name = sanitize(document.getElementById('editChildName').value.trim());
    data.children[childId].defaultRate = parseFloat(document.getElementById('editDefaultRate').value) || 0;
    data.children[childId].defaultExtraRate = parseFloat(document.getElementById('editDefaultExtraRate').value) || 0;
    data.children[childId].color = document.getElementById('editChildColor').value;
    data.children[childId].extraName = sanitize(document.getElementById('editExtraName').value.trim());
    data.children[childId].extraColor = document.getElementById('editExtraColor').value;
    saveData(data);
    renderCalendar();
    closeModal('settingsModal');
};

const deleteChild = () => {
    if (!confirm('È˜tergi definitiv copilul È™i toate datele aferente pentru el?')) return;
    const data = loadData();
    const id = selectedChildIdForModal;
    if (data.children && data.children[id]) delete data.children[id];
    for (const k of Object.keys(data)) {
        if (k === 'children') continue;
        if (data[k].days && data[k].days[id]) delete data[k].days[id];
        if (data[k].daysExtra && data[k].daysExtra[id]) delete data[k].daysExtra[id];
        if (data[k].rates && data[k].rates[id]) delete data[k].rates[id];
        if (data[k].extraRates && data[k].extraRates[id]) delete data[k].extraRates[id];
        if (data[k].payments && data[k].payments[id]) delete data[k].payments[id];
    }
    saveData(data);
    renderCalendar();
    closeModal('settingsModal');
};


/* ================== Payments Modal ================== */
const showPaymentsModal = (childId) => {
    selectedChildIdForModal = childId;
    const data = loadData();
    const key = `${year}-${month}`;
    const childName = data.children[childId].name;
    const monthName = new Date(year, month).toLocaleString('ro-RO', { month: 'long' });
    document.getElementById('paymentsChildName').textContent = sanitize(childName);
    document.getElementById('paymentsMonth').textContent = monthName;
    renderPaymentList();
    openModal('paymentsModal');
};

const renderPaymentList = () => {
    const data = loadData();
    const key = `${year}-${month}`;
    const childId = selectedChildIdForModal;
    const paymentList = document.getElementById('paymentList');
    paymentList.innerHTML = '';

    if (!data[key].payments[childId]) {
        data[key].payments[childId] = [];
    }

    let totalPaid = 0;
    data[key].payments[childId].sort((a,b) => new Date(a.date) - new Date(b.date));

    data[key].payments[childId].forEach((payment, index) => {
        totalPaid += parseFloat(payment.amount);
        const li = document.createElement('li');
        li.innerHTML = `
            <span>${payment.date} - ${parseFloat(payment.amount).toFixed(2)} lei (${payment.type === 'kindergarten' ? 'GrÄƒdiniÈ›Äƒ' : data.children[childId].extraName})</span>
            <button onclick="deletePayment('${childId}', ${index})">&times;</button>
        `;
        paymentList.appendChild(li);
    });

    document.getElementById('paymentsTotal').textContent = totalPaid.toFixed(2);
};

const addPayment = () => {
    const data = loadData();
    const key = `${year}-${month}`;
    const childId = selectedChildIdForModal;
    const amount = parseFloat(document.getElementById('newPaymentAmount').value);
    const dateStr = document.getElementById('newPaymentDate').value;
    const type = document.getElementById('newPaymentType').value;

    if (isNaN(amount) || amount <= 0 || !dateStr) {
        alert("IntroduceÈ›i o sumÄƒ È™i o datÄƒ valide.");
        return;
    }

    const date = new Date(dateStr);
    const day = date.getDate();

    if (!data[key].payments[childId]) {
        data[key].payments[childId] = [];
    }

    const paymentColor = document.getElementById('newPaymentColor').value;
    data[key].payments[childId].push({ amount: amount, date: dateStr, type: type, color: paymentColor });

    if(!data[key].paymentsOnDay) data[key].paymentsOnDay = {};
    if(!data[key].paymentsOnDay[day]) data[key].paymentsOnDay[day] = [];
    data[key].paymentsOnDay[day].push({ childId: childId, amount: amount, color: paymentColor });

    saveData(data);
    document.getElementById('newPaymentAmount').value = '';
    document.getElementById('newPaymentDate').value = '';
    renderPaymentList();
    renderChildrenReports();
    renderCalendar();
};

const deletePayment = (childId, index) => {
    const data = loadData();
    const key = `${year}-${month}`;
    if (confirm('EÈ™ti sigur cÄƒ vrei sÄƒ È™tergi aceastÄƒ platÄƒ?')) {
        const paymentToDelete = data[key].payments[childId][index];
        const date = new Date(paymentToDelete.date);
        const day = date.getDate();

        data[key].payments[childId].splice(index, 1);

        if(data[key].paymentsOnDay && data[key].paymentsOnDay[day]) {
            data[key].paymentsOnDay[day] = data[key].paymentsOnDay[day].filter(p => !(p.childId === childId && p.amount === paymentToDelete.amount && p.color === paymentToDelete.color));
            if(data[key].paymentsOnDay[day].length === 0) {
                delete data[key].paymentsOnDay[day];
            }
        }

        saveData(data);
        renderPaymentList();
        renderChildrenReports();
        renderCalendar();
    }
};


/* ================== EXPORT / IMPORT ================== */
const exportJSON = () => {
    const data = loadData();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `gradinita_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
};

const importJSON = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const obj = JSON.parse(e.target.result);
            saveData(obj);
            alert('Import finalizat. Datele locale au fost Ã®nlocuite.');
            renderCalendar();
        } catch (err) {
            alert('FiÈ™ier JSON invalid.');
        }
    };
    reader.readAsText(file);
    event.target.value = '';
};

const exportExcel = () => {
  const data = loadData();
  const rows = [];
  for(const key of Object.keys(data)){
    if(key === 'children') continue;
    const [y, m] = key.split('-');
    const monthName = new Date(y, m).toLocaleString('ro-RO', { month: 'long' });
    for(const childId of Object.keys(data.children || {})){
      const kindergartenDays = (data[key].days && data[key].days[childId]) ? data[key].days[childId].length : 0;
      const kindergartenRate = (data[key].rates && data[key].rates[childId]) ? data[key].rates[childId] : (data.children[childId]?.defaultRate || 0);
      const extraDays = (data[key].daysExtra && data[key].daysExtra[childId]) ? data[key].daysExtra[childId].length : 0;
      const extraRate = (data[key].extraRates && data[key].extraRates[childId]) ? data[key].extraRates[childId] : (data.children[childId]?.defaultExtraRate || 0);
      const totalKindergarten = kindergartenDays * kindergartenRate;
      const totalExtra = extraDays * extraRate;
      const totalPaidKindergarten = (data[key].payments[childId] || []).filter(p => p.type === 'kindergarten').reduce((sum, p) => sum + parseFloat(p.amount), 0);
      const totalPaidExtra = (data[key].payments[childId] || []).filter(p => p.type === 'extra').reduce((sum, p) => sum + parseFloat(p.amount), 0);

      const balanceKindergarten = totalPaidKindergarten - totalKindergarten;
      const balanceExtra = totalPaidExtra - totalExtra;

      rows.push({
        An: y,
        Luna: monthName,
        Copil: data.children[childId].name,
        "Zile GrÄƒdiniÈ›Äƒ": kindergartenDays,
        "Total GrÄƒdiniÈ›Äƒ": totalKindergarten,
        "PlÄƒtit GrÄƒdiniÈ›Äƒ": totalPaidKindergarten,
        "BalanÈ›Äƒ GrÄƒdiniÈ›Äƒ": balanceKindergarten,
        ["Zile " + data.children[childId].extraName]: extraDays,
        ["Total " + data.children[childId].extraName]: totalExtra,
        ["PlÄƒtit " + data.children[childId].extraName]: totalPaidExtra,
        ["BalanÈ›Äƒ " + data.children[childId].extraName]: balanceExtra
      });
    }
  }

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'PrezenÈ›e');
  XLSX.writeFile(wb, 'gradinita_export.xlsx');
};

const exportPDF = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'pt', 'a4');
    const head = [
        ['An', 'Luna', 'Copil', 'Total GrÄƒd.', 'PlÄƒtit GrÄƒd.', 'BalanÈ›Äƒ GrÄƒd.', 'Total Act.', 'PlÄƒtit Act.', 'BalanÈ›Äƒ Act.']
    ];
    const rows = [];
    const data = loadData();

    for (const key of Object.keys(data)) {
        if (key === 'children') continue;
        const [y, m] = key.split('-');
        const monthName = new Date(y, m).toLocaleString('ro-RO', { month: 'long' });
        for (const childId of Object.keys(data.children || {})) {
            const kindergartenDays = (data[key].days?.[childId] || []).length;
            const kindergartenRate = data[key].rates?.[childId] ?? data.children[childId]?.defaultRate ?? 0;
            const extraDays = (data[key].daysExtra?.[childId] || []).length;
            const extraRate = data[key].extraRates?.[childId] ?? data.children[childId]?.defaultExtraRate ?? 0;
            const totalKindergarten = kindergartenDays * kindergartenRate;
            const totalExtra = extraDays * extraRate;
            const totalPaidKindergarten = (data[key].payments?.[childId] || []).filter(p => p.type === 'kindergarten').reduce((sum, p) => sum + parseFloat(p.amount), 0);
            const totalPaidExtra = (data[key].payments?.[childId] || []).filter(p => p.type === 'extra').reduce((sum, p) => sum + parseFloat(p.amount), 0);
            const balanceKindergarten = totalPaidKindergarten - totalKindergarten;
            const balanceExtra = totalPaidExtra - totalExtra;

            rows.push([
                y, monthName, data.children[childId].name,
                totalKindergarten.toFixed(2), totalPaidKindergarten.toFixed(2), balanceKindergarten.toFixed(2),
                totalExtra.toFixed(2), totalPaidExtra.toFixed(2), balanceExtra.toFixed(2)
            ]);
        }
    }

    doc.autoTable({
        head: head,
        body: rows,
        startY: 40,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [52, 152, 219], textColor: 255 },
        theme: 'grid'
    });
    doc.save('gradinita_export.pdf');
};


/* ================== Resetare date ================== */
const resetData = () => {
    if (!confirm('Sigur vrei sÄƒ È™tergi toate datele stocate local? AceastÄƒ acÈ›iune nu se poate anula.')) return;
    localStorage.removeItem(STORAGE_KEY);
    renderCalendar();
};

/* ================== Navigare lunÄƒ / an ================== */
const changeMonth = (offset) => {
    month += offset;
    if (month < 0) { month = 11; year -= 1; }
    if (month > 11) { month = 0; year += 1; }
    today = new Date(year, month, 1);
    document.getElementById('yearSelectNav').value = year;
    document.getElementById('monthSelectNav').value = month;
    renderCalendar();
};

const changeMonthToSelected = () => {
    month = parseInt(document.getElementById('monthSelectNav').value);
    year = parseInt(document.getElementById('yearSelectNav').value);
    renderCalendar();
};

/* ================== LegendÄƒ culori ================== */
const renderLegend = () => {
    const data = loadData();
    const legend = document.getElementById('legend');
    legend.innerHTML = '';
    if (!data.children) data.children = {};

    for (const childId of Object.keys(data.children)) {
        const child = data.children[childId];
        const itemKindergarten = document.createElement('div');
        itemKindergarten.className = 'legend-item';
        itemKindergarten.innerHTML = `<div class="color-box" style="background:${child.color}"></div><div>${sanitize(child.name)} - GrÄƒdiniÈ›Äƒ</div>`;
        legend.appendChild(itemKindergarten);

        const itemExtra = document.createElement('div');
        itemExtra.className = 'legend-item';
        itemExtra.innerHTML = `<div class="color-box" style="background:${child.extraColor}"></div><div>${sanitize(child.name)} - ${sanitize(child.extraName)}</div>`;
        legend.appendChild(itemExtra);
    }
    const itemPayment = document.createElement('div');
    itemPayment.className = 'legend-item';
    itemPayment.innerHTML = `<div class="color-box" style="background:#2ecc71"></div><div>Indicator PlatÄƒ</div>`;
    legend.appendChild(itemPayment);
};

/* ================== Grafic ================== */
const renderChart = () => {
    const data = loadData();
    const key = `${year}-${month}`;
    const children = data.children || {};
    const labels = [];
    const kindergartenData = [];
    const extraData = [];

    for (const id of Object.keys(children)) {
        labels.push(children[id].name);
        kindergartenData.push((data[key]?.days?.[id] || []).length);
        extraData.push((data[key]?.daysExtra?.[id] || []).length);
    }

    const ctx = document.getElementById('myChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Zile GrÄƒdiniÈ›Äƒ',
                    data: kindergartenData,
                    backgroundColor: Object.values(children).map(c => c.color || '#3498db')
                },
                {
                    label: 'Zile Activitate SuplimentarÄƒ',
                    data: extraData,
                    backgroundColor: Object.values(children).map(c => c.extraColor || '#9b59b6')
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true, title: { display: true, text: 'NumÄƒr de zile' } }
            },
            plugins: {
                title: { display: true, text: `PrezenÈ›a copiilor Ã®n luna ${new Date(year, month).toLocaleString('ro-RO', { month: 'long' })}` }
            }
        }
    });
};

// MODIFICAT: FuncÈ›ionalitate actualizatÄƒ pentru a gestiona selecÈ›ia multiplÄƒ È™i noile coloane de balanÈ›Äƒ
/* ================== Raport general ================== */
const showGeneralReportModal = () => {
    const reportYearSelect = document.getElementById('reportYearSelect');
    reportYearSelect.innerHTML = '';
    const currentYear = new Date().getFullYear();
    for (let i = currentYear - 5; i <= currentYear + 5; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        reportYearSelect.appendChild(option);
    }
    reportYearSelect.value = currentYear;
    openModal('generalReportModal');
    generateGeneralReport();
};

const generateGeneralReport = () => {
    const container = document.getElementById('generalReportContainer');
    container.innerHTML = '<h4>Se genereazÄƒ raportul...</h4>';

    const selectedYear = document.getElementById('reportYearSelect').value;
    const monthSelect = document.getElementById('reportMonthSelect');

    // MODIFICAT: ColecteazÄƒ toate lunile selectate
    let selectedMonths = Array.from(monthSelect.options)
                               .filter(option => option.selected)
                               .map(option => option.value);

    const data = loadData();
    let monthsToReport = [];

    // DacÄƒ este selectat "Toate lunile", se ignorÄƒ restul selecÈ›iilor È™i se iau toate lunile
    if (selectedMonths.includes('-1')) {
        for (let m = 0; m < 12; m++) {
            monthsToReport.push(`${selectedYear}-${m}`);
        }
    } else {
        monthsToReport = selectedMonths.map(m => `${selectedYear}-${m}`);
    }

    // MODIFICAT: Schimbat antetul tabelului
    let reportHTML = `<table id="generalReportTable"><thead><tr>
        <th>An</th><th>LunÄƒ</th><th>Copil</th>
        <th>Total GrÄƒdiniÈ›Äƒ (lei)</th><th>PlÄƒtit GrÄƒdiniÈ›Äƒ (lei)</th><th>BalanÈ›Äƒ GrÄƒdiniÈ›Äƒ (lei)</th>
        <th>Total Activitate (lei)</th><th>PlÄƒtit Activitate (lei)</th><th>BalanÈ›Äƒ Activitate (lei)</th>
        </tr></thead><tbody>`;

    for (const key of monthsToReport) {
        if (!data[key]) continue;
        const [y, m] = key.split('-');
        const monthName = new Date(y, m).toLocaleString('ro-RO', { month: 'long' });

        for (const childId of Object.keys(data.children || {})) {
            const childData = data.children[childId];
            const monthData = data[key];

            const daysKindergarten = (monthData.days?.[childId] || []).length;
            const rateKindergarten = monthData.rates?.[childId] ?? (childData.defaultRate || 0);
            const totalKindergarten = daysKindergarten * rateKindergarten;

            const daysExtra = (monthData.daysExtra?.[childId] || []).length;
            const rateExtra = monthData.extraRates?.[childId] ?? (childData.defaultExtraRate || 0);
            const totalExtra = daysExtra * rateExtra;

            const totalPaidKindergarten = (monthData.payments?.[childId] || []).filter(p => p.type === 'kindergarten').reduce((sum, p) => sum + parseFloat(p.amount), 0);
            const totalPaidExtra = (monthData.payments?.[childId] || []).filter(p => p.type === 'extra').reduce((sum, p) => sum + parseFloat(p.amount), 0);

            // MODIFICAT: Calcul balanÈ›Äƒ separat È™i cu logica inversatÄƒ
            const balanceKindergarten = totalPaidKindergarten - totalKindergarten;
            const balanceExtra = totalPaidExtra - totalExtra;

            reportHTML += `
                <tr>
                    <td>${y}</td>
                    <td>${monthName}</td>
                    <td>${sanitize(childData.name)}</td>
                    <td>${totalKindergarten.toFixed(2)}</td>
                    <td>${totalPaidKindergarten.toFixed(2)}</td>
                    <td style="color: ${balanceKindergarten >= 0 ? '#2ecc71' : '#e74c3c'}; font-weight: bold;">${balanceKindergarten.toFixed(2)}</td>
                    <td>${totalExtra.toFixed(2)}</td>
                    <td>${totalPaidExtra.toFixed(2)}</td>
                    <td style="color: ${balanceExtra >= 0 ? '#2ecc71' : '#e74c3c'}; font-weight: bold;">${balanceExtra.toFixed(2)}</td>
                </tr>
            `;
        }
    }

    reportHTML += '</tbody></table>';
    container.innerHTML = reportHTML;
};


/* ================== Backup automat ================== */
const autoBackup = () => {
    const now = Date.now();
    const lastBackup = localStorage.getItem('lastBackupTime');
    if (!lastBackup || (now - lastBackup > BACKUP_INTERVAL_MS)) {
        exportJSON();
        localStorage.setItem('lastBackupTime', now);
        console.log("Auto-backup completed.");
    }
};

/* ================== IniÈ›ializare ================== */
(function init() {
    const data = loadData();
    if (!data.children || Object.keys(data.children).length === 0) {
        data.children = {};
        const id1 = 'c1';
        const id2 = 'c2';
        data.children[id1] = { name: 'Casian', defaultRate: 15, defaultExtraRate: 20, extraName: 'EnglezÄƒ', color: '#4da6ff', extraColor: '#9b59b6' };
        data.children[id2] = { name: 'Ezra', defaultRate: 15, defaultExtraRate: 20, extraName: 'EnglezÄƒ', color: '#ffd633', extraColor: '#ff6f61' };
        saveData(data);
    }

    document.getElementById('yearSelectNav').value = new Date().getFullYear();
    document.getElementById('monthSelectNav').value = new Date().getMonth();

    renderCalendar();

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => console.log('ServiceWorker registration successful'))
                .catch(error => console.log('ServiceWorker registration failed: ', error));
        });
    }
})();
</script>
</body>
</html>
