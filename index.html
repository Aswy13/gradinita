<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Prezență Grădiniță</title>

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="application-name" content="Grădiniță">
<meta name="apple-mobile-web-app-title" content="Grădiniță">
<meta name="theme-color" content="#3498db">
<meta name="msapplication-navbutton-color" content="#3498db">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="msapplication-starturl" content="/index.html">

<link rel="icon" type="image/png" sizes="192x192" href="https://via.placeholder.com/192.png?text=G">
<link rel="apple-touch-icon" type="image/png" sizes="192x192" href="https://via.placeholder.com/192.png?text=G">

<link rel="manifest" href="manifest.json">

<script async src="https://www.googletagmanager.com/gtag/js?id=G-EN1HVVEL2Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-EN1HVVEL2Q');
</script>

<style>
/* --- Layout general --- */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  padding: 0;
  background: #f0f4f7;
  color: #333;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  min-height: 100vh;
}

/* Container central care încadră tot conținutul */
.container {
  max-width: 1100px;
  width: 95%;
  background: #fff;
  margin: 20px;
  padding: 24px;
  border-radius: 16px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.1);
}

/* Titlu */
h1 {
  text-align: center;
  color: #2c3e50;
  margin-top: 0;
  font-size: 2.2em;
}
h2 {
    font-size: 1.4em;
    color: #34495e;
    border-bottom: 2px solid #ecf0f1;
    padding-bottom: 8px;
    margin-top: 24px;
}

/* Butoane */
button {
  padding: 10px 18px;
  margin: 6px 4px;
  cursor: pointer;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  background: #3498db;
  color: white;
  transition: background-color 0.2s, transform 0.1s;
}
button:hover { background: #2980b9; transform: translateY(-1px); }
.button-group { display: flex; flex-wrap: wrap; justify-content: center; margin-bottom: 12px; }
.button-group-top {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px; /* Spațiu între cele două butoane */
    margin-bottom: 12px;
}
.button-group-top button { margin: 0; flex: 1; min-width: 200px; }

/* Calendar - grid 7 coloane */
.calendar {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  margin: 16px 0 20px 0;
}
.day {
  border-radius: 10px;
  min-height: 55px;
  text-align: center;
  border: 1px solid #ddd;
  cursor: pointer;
  user-select: none;
  font-size: 15px;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  line-height: 1.3;
  transition: background-color 0.3s, transform 0.1s;
}
.day:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
.day .day-number { font-size: 15px; margin-top: 6px; font-weight: bold; }
.day-header {
  font-weight: 700;
  background: #ecf0f1;
  border-radius: 10px;
  padding: 8px 0;
  text-align: center;
}
.day.weekend { color: #888; }
.day.holiday { background-color: #fcebeb; border-color: #e74c3c; } /* Global Holiday Color */

/* Indicatori activitate zilnică */
.day .indicators {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 3px;
  margin-top: 4px;
  margin-bottom: 4px;
}
.day .indicators .indicator {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  border: 1px solid rgba(0,0,0,0.1);
}
.day.note-indicator::after {
    content: "📝";
    position: absolute;
    top: 4px;
    right: 4px;
    font-size: 10px;
}

/* Rapoarte copii */
.report {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  justify-content: center;
  margin-bottom: 24px;
}
.child-report {
  background: #f8f8f8;
  border: 1px solid #e0e0e0;
  border-radius: 12px;
  padding: 16px;
  min-width: 300px;
  box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
  font-size: 0.95em;
}
.child-report h3 {
  margin: 0 0 12px 0;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 1.2em;
}
.child-report h3 span { font-weight: bold; }

/* Inputs */
input[type="number"], input[type="text"], select {
  width: 95%;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin: 6px 0;
  box-sizing: border-box;
}

/* Popup (modals) */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
  backdrop-filter: blur(4px);
  justify-content: center;
  align-items: center;
}
.modal-content {
  background-color: #fff;
  padding: 24px;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  max-width: 500px;
  width: 90%;
  position: relative;
  animation: modal-fadein 0.3s ease-out;
}
.modal-close {
  color: #aaa;
  position: absolute;
  top: 10px;
  right: 15px;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}
.modal-close:hover, .modal-close:focus { color: #000; text-decoration: none; }
@keyframes modal-fadein { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

/* Stiluri pentru butoanele de selecție copil în modal */
.selection-buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 12px;
}
.selection-buttons > span {
    font-weight: bold;
    color: #34495e;
    border-bottom: 1px dotted #ccc;
    padding-bottom: 4px;
}
.selection-buttons button {
    background: #bdc3c7;
    color: #333;
    flex-grow: 1;
    margin: 0;
    padding: 8px 15px;
}
.selection-buttons button:hover { background: #95a5a6; }
.selection-buttons button.active {
    background: #2ecc71;
    color: white;
}
.selection-buttons button.active:hover { background: #27ae60; }
.day-popup-section {
    margin-bottom: 20px;
    padding: 10px;
    border: 1px solid #eee;
    border-radius: 8px;
    background: #fafafa;
}
.day-popup-section h4 {
    margin-top: 0;
    color: #3498db;
    border-bottom: 1px solid #ecf0f1;
    padding-bottom: 5px;
}
.payment-list {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 8px;
}
.payment-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    border-bottom: 1px solid #eee;
    font-size: 0.9em;
}
.payment-list li:last-child {
    border-bottom: none;
}
.payment-list li button {
    background: #e74c3c;
    color: white;
    padding: 4px 8px;
    font-size: 0.8em;
    margin: 0;
    border-radius: 4px;
}
#childSelectionButtons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 12px;
}

/* Stil pentru containerul de activități extra în modal */
#extraActivitiesContainer {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    margin-top: 10px;
    max-height: 200px;
    overflow-y: auto;
}
.extra-activity-item {
    padding: 8px;
    border-bottom: 1px solid #eee;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    align-items: center;
}
.extra-activity-item:last-child {
    border-bottom: none;
}
.extra-activity-item input {
    width: 90%;
}
.extra-activity-item button {
    background: #e74c3c;
    padding: 5px 10px;
    font-size: 0.9em;
    grid-column: span 2; /* Butonul de ștergere ocupă toată lățimea */
}


/* --- Legendă culori --- */
.legend {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px; /* Spațiere între elementele legendei */
    margin-top: 20px;
    padding: 10px;
    border-top: 1px solid #ddd;
}

.legend-item {
    display: flex;
    align-items: center;
    font-size: 0.9em;
    color: #555;
}

.color-box {
    width: 14px; /* Lățimea cutiei de culoare */
    height: 14px; /* Înălțimea cutiei de culoare */
    border-radius: 4px;
    margin-right: 6px; /* Spațiu între cutie și text */
    border: 1px solid rgba(0,0,0,0.1); /* Margine subțire pentru vizibilitate */
}

@media (max-width:768px) {
  .day { min-height:48px; }
  .day-header { padding: 6px 0; }
  /* Modificare: Butoanele de sus vor fi full-width pe mobil */
  .button-group-top { flex-direction: column; gap: 0; }
  .button-group-top button { width: 100%; margin: 4px 0; }
  .child-report { min-width:unset; width:100%; }
  .container { padding:16px; margin:10px; }
}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="flex:1;"></div>
        <h1>Gradinita&Creasa</h1>
        <div style="flex:1; text-align:right; display:flex; gap:8px; justify-content:flex-end;">
            <button onclick="showDonationModal()" style="padding: 8px 12px; margin: 0; background: #2ecc71;">💸 Donații</button>
            <button onclick="shareApp()" style="padding: 8px 12px; margin: 0; background: #3498db;">🔗 Partajează</button>
            <button style="padding: 8px 12px; margin: 0; background: #95a5a6;" onclick="window.open('https://aswy13.github.io/gradinita/', '_blank')">INFO</button>
        </div>
    </div>

  <div style="text-align:center; margin-bottom:12px; display:flex; align-items:center; justify-content:center; gap:8px;">
    <button onclick="changeMonth(-1)">⬅</button>
    <select id="monthSelectNav" onchange="changeMonthToSelected()">
        <option value="0">Ianuarie</option><option value="1">Februarie</option><option value="2">Martie</option>
        <option value="3">Aprilie</option><option value="4">Mai</option><option value="5">Iunie</option>
        <option value="6">Iulie</option><option value="7">August</option><option value="8">Septembrie</option>
        <option value="9">Octombrie</option><option value="10">Noiembrie</option><option value="11">Decembrie</option>
    </select>
    <input type="number" id="yearSelectNav" onchange="changeMonthToSelected()" value="" style="width:80px; text-align:center;" />
    <button onclick="changeMonth(1)">➡</button>
  </div>

  <div class="button-group-top">
    <button id="multiSelectBtn" style="background: #f39c12;" onclick="toggleMultiSelectMode()">🔗 Activează Selecție Multiplă </button>
    <button onclick="openMultiDayModal()" style="background: #e67e22;">
        ✅ Aplică Setările pe Zilele Selectate
    </button>
  </div>
  <div style="text-align:center; margin-bottom:12px;">
    <div id="multiSelectStatus" style="color: #e67e22; font-weight: bold;"></div>
  </div>


  <div id="calendar" class="calendar"></div>

  <div id="chartContainer">
      <canvas id="myChart"></canvas>
  </div>

  <div class="report" id="childrenReports"></div>

  <div class="button-group">
    <button onclick="addChild()">➕ Adaugă copil</button>
    <button onclick="resetData()">🗑️ Resetare date</button>
    <button onclick="exportJSON()">💾 Export JSON</button>
    <input type="file" id="importFile" style="display:none" accept=".json" onchange="importJSON(event)">
    <button onclick="document.getElementById('importFile').click()">📂 Import JSON</button>
  </div>

  <div class="button-group">
    <button onclick="exportExcel()">📊 Export Excel</button>
    <button onclick="exportPDF()">📄 Export PDF</button>
    <button onclick="showGeneralReportModal()">📈 Generare Raport General</button>
  </div>

  <div class="legend" id="legend"></div>
    <div style="text-align: center; margin-top: 20px; color: #7f8c8d; font-size: 0.9em;">
        Aplicație creată de Aswy
    </div>
</div>

<div id="dayModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('dayModal')">&times;</span>
        <h3 style="text-align: center;">Detalii pentru ziua <span id="modalDayNumber"></span></h3>

        <div class="day-popup-section">
            <h4>Sărbătoare Legală (Toți Copiii)</h4>
            <button id="globalHolidayBtn" style="width: 100%;" onclick="applyGlobalHoliday()">Marchează/Anulează Sărbătoare Legală (Globală)</button>
        </div>

        <div class="day-popup-section">
            <h4>Prezență și Activități Individuale</h4>
            <div id="childSelectionButtons"></div>
        </div>

        <div class="day-popup-section">
            <h4>Notițe</h4>
            <textarea id="noteTextarea" placeholder="Adaugă o notiță (ex: schemă de mâncare, observație)..." style="width: 100%; height: 80px;"></textarea>
            <button onclick="saveNote()">Salvează notița</button>
        </div>

        <div style="display: flex; justify-content: space-between; gap: 8px;">
            <button style="background-color: #e74c3c; width: 100%;" onclick="clearDaySelections()">Șterge toate selecțiile</button>
            <button style="background-color: #3498db; width: 100%;" onclick="closeModal('dayModal')">Închide</button>
        </div>
    </div>
</div>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('settingsModal')">&times;</span>
        <h3>Setări pentru <span id="settingsChildName"></span></h3>
        <label>Nume copil:</label><br>
        <input type="text" id="editChildName" /><br>
        <label>Cost standard Grădiniță:</label><br>
        <input type="number" id="editDefaultRate" /><br>
        <label>Culoare Grădiniță:</label><br>
        <input type="color" id="editChildColor" /><br>

        <h4>Activități Suplimentare</h4>
        <div id="extraActivitiesContainer">
            </div>
        <button onclick="addExtraActivityInput()" style="margin-top: 10px; background: #27ae60;">➕ Adaugă Activitate</button>

        <div style="display:flex; justify-content:space-between; margin-top:20px;">
            <button style="background: #e74c3c; flex: 1; margin: 0 4px;" onclick="deleteChild()">Șterge copil</button>
            <button style="background: #2ecc71; flex: 1; margin: 0 4px;" onclick="saveChildSettings()">Salvează</button>
        </div>
    </div>
</div>

<div id="paymentsModal" class="modal">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('paymentsModal')">&times;</span>
        <h3>Istoric plăți <span id="paymentsChildName"></span> (<span id="paymentsMonth"></span>)</h3>
        <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;">
            <div style="display: flex; gap: 8px;">
                <input type="number" id="newPaymentAmount" placeholder="Sumă" style="flex: 1;"/>
                <input type="date" id="newPaymentDate" style="flex: 1;"/>
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
                <label>Plată pentru:</label>
                <select id="newPaymentType" style="flex: 1;">
                    </select>
                <label>Culoare plată:</label>
                <input type="color" id="newPaymentColor" value="#2ecc71" style="width: 50px;"/>
            </div>
            <button onclick="addPayment()">Adaugă plată</button>
        </div>
        <ul id="paymentList" class="payment-list"></ul>
        <div style="margin-top: 15px; font-weight: bold; font-size: 1.1em;">
            Total plătit: <span id="paymentsTotal">0</span>
        </div>
    </div>
</div>

<div id="generalReportModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <span class="modal-close" onclick="closeModal('generalReportModal')">&times;</span>
        <h3 style="text-align: center;">Raport General</h3>
        <div class="report-options">
            <label>An:</label>
            <select id="reportYearSelect"></select>
            <label>Lună (selectați mai multe cu Ctrl/Cmd):</label>
            <select id="reportMonthSelect" multiple style="height: 150px;">
                <option value="-1">Toate lunile</option>
                <option value="0">Ianuarie</option><option value="1">Februarie</option><option value="2">Martie</option>
                <option value="3">Aprilie</option><option value="4">Mai</option><option value="5">Iunie</option>
                <option value="6">Iulie</option><option value="7">August</option><option value="8">Septembrie</option>
                <option value="9">Octombrie</option><option value="10">Noiembrie</option><option value="11">Decembrie</option>
            </select>
            <button onclick="generateGeneralReport()">Generează Raport</button>
        </div>
        <div id="generalReportContainer"></div>
    </div>
</div>

<script>
/* ================== VARIABILE & CONFIG ================== */
const STORAGE_KEY = 'gradinitaDataV8'; // Versiune nouă pentru structură individuală de zile libere
const BACKUP_INTERVAL_MS = 60 * 60 * 1000;
let lastBackupTime = 0;

let today = new Date();
let month = today.getMonth();
let year = today.getFullYear();
let selectedDays = [];
let selectedCell = null;
let chartInstance = null;
let isMultiSelectMode = false;
let selectedChildIdForModal = null;

const showDonationModal = () => {
    // INLOCUIESTE CU IBAN-UL TAU REAL
    const iban = "RO00 RZBR 0000 0000 0000 0000";
    const message = `Mulțumesc pentru suport!\n\nIBAN: ${iban}\nBanca: Raiffeisen Bank\nTitular: [Numele tău]`;
    alert(message);
};

const shareApp = () => {
    const shareData = {
        title: 'Aplicație Prezență Grădiniță',
        text: 'O aplicație utilă pentru a ține evidența prezenței și costurilor la grădiniță.',
        url: 'https://aswy13.github.io/gradinita/'
    };
    if (navigator.share) {
        navigator.share(shareData)
            .then(() => console.log('Shared successfully'))
            .catch((error) => console.log('Error sharing:', error));
    } else {
        // Fallback pentru desktop
        navigator.clipboard.writeText(shareData.url).then(() => {
            alert('Link-ul aplicației a fost copiat în clipboard! Îl poți distribui unde dorești.');
        }).catch(err => {
            alert('Nu am putut copia link-ul. Îl poți copia manual: ' + shareData.url);
        });
    }
};


/* ================== HELPER: load/save localStorage ================== */
const loadData = () => {
    try {
        const data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        if (!data.children || typeof data.children !== 'object') {
            data.children = {};
        }
        return data;
    } catch (e) {
        console.error("Failed to load data from localStorage", e);
        return { children: {} };
    }
};

const saveData = (data) => {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
        console.error("Failed to save data to localStorage", e);
    }
};

const sanitize = (input) => {
    if (typeof input !== 'string') return input;
    const temp = document.createElement('div');
    temp.textContent = input;
    return temp.innerHTML;
};

/* ================== ACCOUNTING LOGIC (CUMULATIVE BALANCE) ================== */
const getHistoricalBalance = (currentYear, currentMonth, childId, data) => {
    let cumulativeCost = 0;
    let cumulativePaid = 0;
    const allKeys = Object.keys(data).filter(k => k !== 'children');
    allKeys.sort((a, b) => {
        const [aY, aM] = a.split('-').map(Number);
        const [bY, bM] = b.split('-').map(Number);
        if (aY !== bY) return aY - bY;
        return aM - bM;
    });

    for (const key of allKeys) {
        const [y, m] = key.split('-').map(Number);
        if (y > currentYear || (y === currentYear && m >= currentMonth)) break;

        const monthData = data[key];
        const childData = data.children[childId];
        if (!childData) continue;

        // 1. Cost Grădiniță
        // Se calculează doar costul estimat pentru lunile anterioare pentru un istoric corect
        const daysInMonth = new Date(y, parseInt(m) + 1, 0).getDate();
        const rateKindergarten = monthData.rates?.[childId] ?? childData.defaultRate;

        let daysToCharge = 0;
        const individualNonWorkingDays = monthData.individualNonWorkingDays?.[childId] || [];

        for (let d = 1; d <= daysInMonth; d++) {
            // Dacă ziua este marcată individual ca nelucrătoare, nu se contorizează la plată.
            if (!individualNonWorkingDays.includes(d)) {
                // Pentru costul ISTORIC, folosim zilele efective de prezență
                 if (monthData.days?.[childId]?.includes(d)) {
                     daysToCharge++;
                 }
            }
        }

        cumulativeCost += daysToCharge * rateKindergarten;


        // 2. Cost Activități Suplimentare (iterare prin toate)
        if (childData.extraActivities && monthData.extraAttendances?.[childId]) {
            for (const activity of childData.extraActivities) {
                const extraDays = (monthData.extraAttendances[childId][activity.id] || []).length;
                cumulativeCost += extraDays * (activity.rate || 0);
            }
        }

        // 3. Plăți
        const totalPaid = (monthData.payments?.[childId] || []).reduce((sum, p) => sum + parseFloat(p.amount), 0);
        cumulativePaid += totalPaid;
    }
    return cumulativePaid - cumulativeCost;
};

/* ================== RENDER: calendar + rapoarte ================== */
const renderCalendar = () => {
    const calendar = document.getElementById('calendar');
    calendar.innerHTML = '';
    const data = loadData();
    const key = `${year}-${month}`;

    if (!data[key]) {
        // Această structură este preluată în init, nu aici, pentru a asigura popularea cu weekends.
        // Aici doar ne asigurăm că există structura minimă
        data[key] = {
            days: {},
            extraAttendances: {},
            absences: {},
            rates: {},
            notes: {},
            payments: {},
            globalHolidays: [], // NOU: Sărbători legale (toți copiii)
            individualNonWorkingDays: {}, // NOU: Zile libere per copil (inclusiv weekends)
            paymentsOnDay: {}
        };
        saveData(data);
    }

    const weekdays = ['Lu', 'Ma', 'Mi', 'Jo', 'Vi', 'Sa', 'Du'];
    weekdays.forEach((w, idx) => {
        const el = document.createElement('div');
        el.className = 'day-header';
        if (idx >= 5) el.classList.add('weekend');
        el.textContent = w;
        calendar.appendChild(el);
    });

    const firstDay = new Date(year, month, 1).getDay();
    const empty = firstDay === 0 ? 6 : firstDay - 1;
    for (let i = 0; i < empty; i++) calendar.appendChild(document.createElement('div'));

    const daysInMonth = new Date(year, month + 1, 0).getDate();
    for (let d = 1; d <= daysInMonth; d++) {
        const day = document.createElement('div');
        day.className = 'day';
        day.dataset.day = d;
        day.innerHTML = `<span class="day-number">${d}</span>`;
        day.onclick = (e) => toggleCtrlSelection(d, day, e);
        updateDayDisplay(day, d, data[key]);
        calendar.appendChild(day);
    }

    document.getElementById('monthSelectNav').value = month;
    document.getElementById('yearSelectNav').value = year;

    renderChildrenReports();
    renderLegend();
    renderChart();
};

const updateDayDisplay = (cell, day, monthData) => {
    cell.style.backgroundColor = '';
    cell.style.color = '#333';
    cell.style.border = '1px solid #ddd';
    cell.style.background = '';
    cell.classList.remove('note-indicator', 'weekend', 'holiday');
    cell.style.outline = selectedDays.includes(day) ? '3px solid #3498db' : '';

    let indicators = cell.querySelector('.indicators');
    if(indicators) indicators.remove();
    indicators = document.createElement('div');
    indicators.className = 'indicators';

    const date = new Date(year, month, day);
    if (date.getDay() === 0 || date.getDay() === 6) {
        cell.classList.add('weekend');
    }

    if (!monthData) return;

    if(monthData.notes && monthData.notes[day]){
        cell.classList.add('note-indicator');
        cell.title = `Notiță: ${sanitize(monthData.notes[day])}`;
    }

    // Indicator pentru Sărbătoare Globală (Toți copiii)
    if(monthData.globalHolidays && monthData.globalHolidays.includes(day)){
        cell.classList.add('holiday');
        cell.title = (cell.title ? cell.title + '\n' : '') + "Sărbătoare Legală (Globală)";
    }

    const childrenData = loadData().children;
    let cellTooltipContent = '';

    // Adaugă indicatori vizuali ("buline") pentru plăți
    if (monthData.paymentsOnDay && monthData.paymentsOnDay[day]) {
        monthData.paymentsOnDay[day].forEach(payment => {
            const indicator = document.createElement('div');
            indicator.className = 'indicator';
            indicator.style.backgroundColor = payment.color || '#2ecc71'; // Culoarea plății
            const childName = childrenData[payment.childId]?.name || 'Necunoscut';
            const paymentTooltip = `Plată ${payment.amount} lei - ${sanitize(childName)}`;
            indicator.title = paymentTooltip;
            indicators.appendChild(indicator);
            cellTooltipContent += (cellTooltipContent ? '\n' : '') + paymentTooltip;
        });
    }


    for (const childId of Object.keys(childrenData)) {
        const childName = sanitize(childrenData[childId].name);
        let status = null; // 'present', 'absent', 'non-working'

        // Status Zi Nelucrătoare Individuală (trebuie să fie prioritar la plată)
        if(monthData.individualNonWorkingDays?.[childId]?.includes(day)){
             status = 'non-working';
             const indicator = document.createElement('div');
             indicator.className = 'indicator';
             indicator.style.backgroundColor = '#e8f4fb'; // Culoare pentru non-working individual
             indicator.title = `${childName} - Zi Nelucrătoare (Nu se Contorizează)`;
             indicators.appendChild(indicator);
             cellTooltipContent += (cellTooltipContent ? '\n' : '') + `${childName} - Zi Nelucrătoare`;
             continue; // Dacă e zi nelucrătoare individuală, nu mai afișăm prezența/absența
        }

        if (monthData.absences?.[childId]?.includes(day)) {
            status = 'absent';
            const indicator = document.createElement('div');
            indicator.className = 'indicator';
            indicator.style.backgroundColor = '#bdc3c7';
            indicator.style.border = '1px dashed #7f8c8d';
            indicator.title = `${childName} - Absent`;
            indicators.appendChild(indicator);
            cellTooltipContent += (cellTooltipContent ? '\n' : '') + `${childName} - Absent`;
            continue;
        }

        if (monthData.days?.[childId]?.includes(day)) {
            status = 'present';
            const indicator = document.createElement('div');
            indicator.className = 'indicator';
            indicator.style.backgroundColor = childrenData[childId]?.color || '#3498db';
            indicator.title = `${childName} - Grădiniță`;
            indicators.appendChild(indicator);
            cellTooltipContent += (cellTooltipContent ? '\n' : '') + `${childName} - Grădiniță`;
        }

        if (childrenData[childId].extraActivities && monthData.extraAttendances?.[childId]) {
            for (const activity of childrenData[childId].extraActivities) {
                if (monthData.extraAttendances[childId][activity.id]?.includes(day)) {
                    const indicator = document.createElement('div');
                    indicator.className = 'indicator';
                    indicator.style.backgroundColor = activity.color || '#9b59b6';
                    indicator.title = `${childName} - ${sanitize(activity.name)}`;
                    indicators.appendChild(indicator);
                    cellTooltipContent += (cellTooltipContent ? '\n' : '') + `${childName} - ${sanitize(activity.name)}`;
                }
            }
        }
    }

    if (indicators.children.length > 0) {
        cell.appendChild(indicators);
    }

    if (cellTooltipContent) {
        cell.title = (cell.title ? cell.title + '\n---\n' : '') + cellTooltipContent;
    }
};

/* ================== MODALS ================== */
const clearMultiSelection = () => {
    selectedDays.forEach(d => {
        const cell = document.querySelector(`.day[data-day='${d}']`);
        if (cell) updateDayDisplay(cell, d, loadData()[`${year}-${month}`]); // Re-render for outline removal
    });
    selectedDays = [];
    document.getElementById('multiSelectStatus').textContent = '';
};

const openModal = (modalId) => document.getElementById(modalId).style.display = 'flex';
const closeModal = (modalId) => {
    document.getElementById(modalId).style.display = 'none';
    if(modalId === 'dayModal') clearMultiSelection();
};

const openMultiDayModal = () => {
    if (selectedDays.length > 0) {
        showDayModal(selectedDays[0], null);
    } else {
        alert('Vă rugăm selectați cel puțin o zi.');
    }
};

const showDayModal = (day, elCell) => {
    const daysText = selectedDays.length > 1 ? selectedDays.sort((a,b)=>a-b).join(', ') : day;
    document.getElementById('modalDayNumber').textContent = daysText;
    const data = loadData();
    const key = `${year}-${month}`;
    const children = data.children || {};
    const childSelectionButtons = document.getElementById('childSelectionButtons');
    childSelectionButtons.innerHTML = '';

    // Logica pentru butonul de Sărbătoare GLOBALĂ
    const isGlobalHoliday = selectedDays.every(d => data[key].globalHolidays && data[key].globalHolidays.includes(d));
    const holidayBtn = document.getElementById('globalHolidayBtn');
    holidayBtn.textContent = isGlobalHoliday ? 'Anulează Sărbătoare Legală (Globală)' : 'Marchează ca Sărbătoare Legală (Globală)';
    holidayBtn.style.backgroundColor = isGlobalHoliday ? '#e74c3c' : '#2ecc71';


    for (const id of Object.keys(children)) {
        // Verifica daca TOATE zilele selectate au prezenta / absenta / zi nelucratoare respectiva
        const isKindergartenActive = selectedDays.every(d => data[key].days?.[id]?.includes(d));
        const isAbsent = selectedDays.every(d => data[key].absences?.[id]?.includes(d));
        const isNonWorking = selectedDays.every(d => data[key].individualNonWorkingDays?.[id]?.includes(d)); // NOU

        const childSection = document.createElement('div');
        childSection.className = 'selection-buttons';
        let buttonsHTML = `<span>${sanitize(children[id].name)}</span>`;

        // Butonul Zi Nelucrătoare Individuală
        buttonsHTML += `<button class="${isNonWorking ? 'active' : ''}" style="background-color: ${isNonWorking ? '#9b59b6' : '#bdc3c7'}; color: ${isNonWorking ? 'white' : '#333'};" onclick="applyIndividualNonWorkingDay('${id}')">${isNonWorking ? 'Anulează Zi Nelucrătoare (Plată)' : 'Marchează Zi Nelucrătoare (Nu Plătești)'}</button>`;

        // Butonul Absent/Prezent: (logică păstrată)
        buttonsHTML += `<button class="${isAbsent ? 'active' : ''}" style="background-color: ${isAbsent ? '#e74c3c' : '#7f8c8d'};" onclick="applyMultiAbsence('${id}')">${isAbsent ? 'Marchează ca Prezent' : 'Marchează ca Absent'}</button>`;

        // Butonul Grădiniță: (logică păstrată)
        buttonsHTML += `<button class="${isKindergartenActive ? 'active' : ''}" onclick="applyMultiPresence('${id}','kindergarten')">${isKindergartenActive ? 'Anulează Grădiniță' : 'Marchează Grădiniță'}</button>`;

        if (children[id].extraActivities) {
            for (const activity of children[id].extraActivities) {
                const isExtraActive = selectedDays.every(d => data[key].extraAttendances?.[id]?.[activity.id]?.includes(d));
                const buttonColor = activity.color || '#9b59b6';
                buttonsHTML += `<button class="${isExtraActive ? 'active' : ''}" style="background-color: ${isExtraActive ? buttonColor : '#bdc3c7'}; color: ${isExtraActive ? 'white' : '#333'};" onclick="applyMultiPresence('${id}','extra','${activity.id}')">${isExtraActive ? 'Anulează ' : 'Marchează '}${sanitize(activity.name)}</button>`;
            }
        }
        childSection.innerHTML = buttonsHTML;
        childSelectionButtons.appendChild(childSection);
    }

    const existingNote = (data[key].notes && data[key].notes[selectedDays[0]]) || '';
    document.getElementById('noteTextarea').value = sanitize(existingNote);
    openModal('dayModal');
};

const saveNote = () => {
    const data = loadData();
    const key = `${year}-${month}`;
    if (!data[key].notes) data[key].notes = {};
    const note = document.getElementById('noteTextarea').value.trim();
    if (note) {
        selectedDays.forEach(d => {
            data[key].notes[d] = sanitize(note);
        });
    } else {
        selectedDays.forEach(d => {
            delete data[key].notes[d];
        });
    }
    saveData(data);
    renderCalendar();
    closeModal('dayModal');
};

const clearDaySelections = () => {
    const data = loadData();
    const key = `${year}-${month}`;
    selectedDays.forEach(d => {
        for (const childId in data.children) {
            if (data[key].days?.[childId]) data[key].days[childId] = data[key].days[childId].filter(day => day !== d);
            if (data[key].extraAttendances?.[childId]) {
                for(const activityId in data[key].extraAttendances[childId]){
                    data[key].extraAttendances[childId][activityId] = data[key].extraAttendances[childId][activityId].filter(day => day !== d);
                }
            }
            if (data[key].absences?.[childId]) {
                data[key].absences[childId] = data[key].absences[childId].filter(day => day !== d);
            }
            // NOU: Șterge și zi nelucrătoare individuală
            if (data[key].individualNonWorkingDays?.[childId]) {
                data[key].individualNonWorkingDays[childId] = data[key].individualNonWorkingDays[childId].filter(day => day !== d);
            }
        }
        // Șterge și global holiday
        if (data[key].globalHolidays) data[key].globalHolidays = data[key].globalHolidays.filter(day => day !== d);
        if (data[key].notes) delete data[key].notes[d];
    });
    saveData(data);
    renderCalendar();
    closeModal('dayModal');
};

const toggleMultiSelectMode = () => {
    isMultiSelectMode = !isMultiSelectMode;
    const btn = document.getElementById('multiSelectBtn');
    const statusDiv = document.getElementById('multiSelectStatus');
    if (isMultiSelectMode) {
        btn.textContent = '⛔ Ieși din Modul Multi-Select';
        btn.style.background = '#e74c3c';
        statusDiv.textContent = 'Mod activat. Apasă pe zile pentru a selecta.';
    } else {
        btn.textContent = '🔗 Activează Selecție Multiplă (Mobil)';
        btn.style.background = '#f39c12';
        clearMultiSelection();
        statusDiv.textContent = '';
    }
};

const toggleCtrlSelection = (day, elCell, event) => {
    const isCtrlKey = event.ctrlKey || event.metaKey || isMultiSelectMode;
    const index = selectedDays.indexOf(day);

    if (isCtrlKey) {
        if (index > -1) {
            selectedDays.splice(index, 1);
        } else {
            selectedDays.push(day);
        }
        updateDayDisplay(elCell, day, loadData()[`${year}-${month}`]);
        document.getElementById('multiSelectStatus').textContent = `Zile selectate: ${selectedDays.length}`;
        return;
    } else {
        const isOpeningMulti = selectedDays.length > 0 && index > -1;
        if (!isOpeningMulti) {
            clearMultiSelection();
            selectedDays = [day];
            updateDayDisplay(elCell, day, loadData()[`${year}-${month}`]);
        }
        showDayModal(day, elCell);
    }
};

// MODIFICAT: Nu mai închide modalul, ci îl re-rendează
const applyMultiPresence = (childId, type, activityId = null) => {
    const data = loadData();
    const key = `${year}-${month}`;

    let daysField, isTogglingOn;

    if (type === 'kindergarten') {
        if (!data[key].days) data[key].days = {};
        if (!data[key].days[childId]) data[key].days[childId] = [];
        daysField = data[key].days[childId];
        isTogglingOn = !selectedDays.every(d => daysField.includes(d));
    } else { // type === 'extra'
        if (!data[key].extraAttendances) data[key].extraAttendances = {};
        if (!data[key].extraAttendances[childId]) data[key].extraAttendances[childId] = {};
        if (!data[key].extraAttendances[childId][activityId]) data[key].extraAttendances[childId][activityId] = [];
        daysField = data[key].extraAttendances[childId][activityId];
        isTogglingOn = !selectedDays.every(d => daysField.includes(d));
    }

    selectedDays.forEach(d => {
        const idx = daysField.indexOf(d);
        if (isTogglingOn) {
            if (idx === -1) daysField.push(d);
            // Șterge Absența și Zi Nelucrătoare Individuală dacă marchezi Prezență
            if (data[key].absences?.[childId]?.includes(d)) data[key].absences[childId] = data[key].absences[childId].filter(h => h !== d);
            if (data[key].individualNonWorkingDays?.[childId]?.includes(d)) data[key].individualNonWorkingDays[childId] = data[key].individualNonWorkingDays[childId].filter(h => h !== d);
        } else {
            if (idx > -1) daysField.splice(idx, 1);
        }
    });

    saveData(data);
    renderCalendar();
    showDayModal(selectedDays[0], null);
};

// MODIFICAT: Nu mai închide modalul, ci îl re-rendează
const applyMultiAbsence = (childId) => {
    const data = loadData();
    const key = `${year}-${month}`;
    if (!data[key].absences) data[key].absences = {};
    if (!data[key].absences[childId]) data[key].absences[childId] = [];

    const isTogglingOn = !selectedDays.every(d => data[key].absences[childId].includes(d));

    selectedDays.forEach(d => {
        const idx = data[key].absences[childId].indexOf(d);
        if (isTogglingOn) {
            if (idx === -1) data[key].absences[childId].push(d);
            // Șterge prezența la grădiniță și activități extra
            if (data[key].days?.[childId]) data[key].days[childId] = data[key].days[childId].filter(day => day !== d);
            if (data[key].extraAttendances?.[childId]) {
                 for(const activityId in data[key].extraAttendances[childId]){
                    data[key].extraAttendances[childId][activityId] = data[key].extraAttendances[childId][activityId].filter(day => day !== d);
                }
            }
        } else {
            if (idx > -1) data[key].absences[childId].splice(idx, 1);
        }
    });

    saveData(data);
    renderCalendar();
    showDayModal(selectedDays[0], null);
};

// NOU: Marchează Zi Nelucrătoare (care nu se plătește) INDIVIDUAL
const applyIndividualNonWorkingDay = (childId) => {
    const data = loadData();
    const key = `${year}-${month}`;
    if (!data[key].individualNonWorkingDays) data[key].individualNonWorkingDays = {};
    if (!data[key].individualNonWorkingDays[childId]) data[key].individualNonWorkingDays[childId] = [];

    const daysField = data[key].individualNonWorkingDays[childId];
    const isTogglingOn = !selectedDays.every(d => daysField.includes(d));

    selectedDays.forEach(d => {
        const idx = daysField.indexOf(d);
        if (isTogglingOn) {
            if (idx === -1) daysField.push(d);
            // Dacă e zi nelucrătoare, șterge toate prezențele și absențele
             if (data[key].days?.[childId]) data[key].days[childId] = data[key].days[childId].filter(day => day !== d);
             if (data[key].extraAttendances?.[childId]) {
                 for(const activityId in data[key].extraAttendances[childId]){
                    data[key].extraAttendances[childId][activityId] = data[key].extraAttendances[childId][activityId].filter(day => day !== d);
                 }
             }
             if (data[key].absences?.[childId]) data[key].absences[childId] = data[key].absences[childId].filter(day => day !== d);
        } else {
            if (idx > -1) daysField.splice(idx, 1);
        }
    });
    saveData(data);
    renderCalendar();
    showDayModal(selectedDays[0], null);
};


// MODIFICAT: Sărbătoare GLOBALĂ (pentru vechea applyMultiHoliday)
const applyGlobalHoliday = () => {
    const data = loadData();
    const key = `${year}-${month}`;
    if (!data[key].globalHolidays) data[key].globalHolidays = [];
    const isTogglingOn = !selectedDays.every(d => data[key].globalHolidays.includes(d));

    selectedDays.forEach(d => {
        const idx = data[key].globalHolidays.indexOf(d);
        if (isTogglingOn) {
            if (idx === -1) data[key].globalHolidays.push(d);
            // Șterge toate prezențele pentru toți copiii
            for(const childId in data.children){
                if (data[key].days?.[childId]) data[key].days[childId] = data[key].days[childId].filter(day => day !== d);
                if (data[key].extraAttendances?.[childId]) {
                    for(const activityId in data[key].extraAttendances[childId]){
                        data[key].extraAttendances[childId][activityId] = data[key].extraAttendances[childId][activityId].filter(day => day !== d);
                    }
                }
            }
        } else {
            if (idx > -1) data[key].globalHolidays.splice(idx, 1);
        }
    });
    saveData(data);
    renderCalendar();
    showDayModal(selectedDays[0], null);
};


/* ================== Child Management (Modals) ================== */
const addChild = () => {
    // Trimite un eveniment anonim la Google Analytics
    if (typeof gtag === 'function') {
        gtag('event', 'add_child');
    }

    const data = loadData();
    const newId = `c${Date.now()}`;
    const newChild = {
        name: `Copil Nou ${Object.keys(data.children).length + 1}`,
        defaultRate: 15,
        color: getRandomColor(),
        extraActivities: [
            { id: `e${Date.now()}`, name: 'Engleză', rate: 20, color: getRandomColor() }
        ]
    };
    data.children[newId] = newChild;

    // NOU: Inițializează zilele nelucrătoare (weekend) și pentru copilul nou
    const key = `${year}-${month}`;
    if(data[key]?.individualNonWorkingDays) {
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const defaultNonWorkingDays = [];
        for (let d = 1; d <= daysInMonth; d++) {
            const date = new Date(year, month, d);
            if (date.getDay() === 0 || date.getDay() === 6) { // 0=Duminica, 6=Sambata
                defaultNonWorkingDays.push(d);
            }
        }
        data[key].individualNonWorkingDays[newId] = defaultNonWorkingDays;
    }

    saveData(data);
    renderCalendar();
};

const getRandomColor = () => {
    const letters = '0123456789ABCDEF';
    let color = '#';
    for (let i = 0; i < 6; i++) color += letters[Math.floor(Math.random() * 16)];
    return color;
};

// MODIFICAT: Logica de calcul a zilelor de plata, excluzând individualNonWorkingDays
const getEstimatedMonthlyKindergartenCost = (y, m, childId, data) => {
    const key = `${y}-${m}`;
    const child = data.children[childId];
    if (!child) return 0;
    const rateKindergarten = data[key]?.rates?.[childId] ?? child.defaultRate;
    const daysInMonth = new Date(y, parseInt(m) + 1, 0).getDate();

    let workingDays = 0;
    const individualNonWorkingDays = data[key]?.individualNonWorkingDays?.[childId] || [];

    for (let d = 1; d <= daysInMonth; d++) {
        // Dacă ziua NU este în lista individuală de zile nelucrătoare
        if (!individualNonWorkingDays.includes(d)) {
            workingDays++;
        }
    }
    return workingDays * rateKindergarten;
};

const showSettingsModal = (childId) => {
    selectedChildIdForModal = childId;
    const data = loadData();
    const child = data.children[childId];
    document.getElementById('settingsChildName').textContent = sanitize(child.name);
    document.getElementById('editChildName').value = sanitize(child.name);
    document.getElementById('editDefaultRate').value = child.defaultRate;
    document.getElementById('editChildColor').value = child.color || '#3498db';

    const container = document.getElementById('extraActivitiesContainer');
    container.innerHTML = '';
    if (child.extraActivities) {
        child.extraActivities.forEach(activity => {
            addExtraActivityInput(activity);
        });
    }
    openModal('settingsModal');
};

const addExtraActivityInput = (activity = null) => {
    // Dacă funcția este apelată fără un parametru, înseamnă că se adaugă o activitate nouă
    if (activity === null && typeof gtag === 'function') {
        gtag('event', 'add_activity');
    }

    const container = document.getElementById('extraActivitiesContainer');
    const activityId = activity ? activity.id : `e${Date.now()}`;
    const name = activity ? activity.name : '';
    const rate = activity ? activity.rate : '';
    const color = activity ? activity.color : getRandomColor();

    const item = document.createElement('div');
    item.className = 'extra-activity-item';
    item.dataset.id = activityId;
    item.innerHTML = `
        <input type="text" placeholder="Nume activitate" value="${sanitize(name)}">
        <input type="number" placeholder="Cost" value="${rate}">
        <label>Culoare:</label>
        <input type="color" value="${color}">
        <button onclick="this.parentElement.remove()">Șterge Activitate</button>
    `;
    container.appendChild(item);
};

const saveChildSettings = () => {
    const data = loadData();
    const childId = selectedChildIdForModal;
    if (!data.children[childId]) return;
    data.children[childId].name = sanitize(document.getElementById('editChildName').value.trim());
    data.children[childId].defaultRate = parseFloat(document.getElementById('editDefaultRate').value) || 0;
    data.children[childId].color = document.getElementById('editChildColor').value;

    const container = document.getElementById('extraActivitiesContainer');
    data.children[childId].extraActivities = [];
    container.querySelectorAll('.extra-activity-item').forEach(item => {
        const inputs = item.querySelectorAll('input');
        data.children[childId].extraActivities.push({
            id: item.dataset.id,
            name: sanitize(inputs[0].value.trim()),
            rate: parseFloat(inputs[1].value) || 0,
            color: inputs[2].value
        });
    });

    saveData(data);
    renderCalendar();
    closeModal('settingsModal');
};

const deleteChild = () => {
    if (!confirm('Ștergi definitiv copilul și toate datele aferente pentru el?')) return;
    const data = loadData();
    const id = selectedChildIdForModal;
    if (data.children && data.children[id]) delete data.children[id];
    for (const k of Object.keys(data)) {
        if (k === 'children') continue;
        if (data[k].days?.[id]) delete data[k].days[id];
        if (data[k].extraAttendances?.[id]) delete data[k].extraAttendances[id];
        if (data[k].absences?.[id]) delete data[k].absences[id];
        if (data[k].rates?.[id]) delete data[k].rates[id];
        if (data[k].payments?.[id]) delete data[k].payments[id];
        if (data[k].individualNonWorkingDays?.[id]) delete data[k].individualNonWorkingDays[id]; // NOU: Șterge zilele libere individuale
    }
    saveData(data);
    renderCalendar();
    closeModal('settingsModal');
};


/* ================== RENDER rapoarte per copil - LOGICĂ NOUĂ ================== */
const renderChildrenReports = () => {
    const container = document.getElementById('childrenReports');
    container.innerHTML = '';
    const data = loadData();
    const children = data.children || {};
    const key = `${year}-${month}`;
    if (!data[key]) data[key] = { days: {}, extraAttendances: {}, absences: {}, rates: {}, notes: {}, payments: {}, globalHolidays: [], individualNonWorkingDays: {}, paymentsOnDay: {} };

    for (const id of Object.keys(children)) {
        const childData = children[id];
        const monthData = data[key];
        const previousMonthBalance = getHistoricalBalance(year, month, id, data);

        // --- Calcul Costuri ---
        const rateKindergarten = monthData.rates?.[id] ?? childData.defaultRate;
        const individualNonWorkingDays = monthData.individualNonWorkingDays?.[id] || [];

        // Numărul de zile plătibile (Total zile din lună - Zile nelucrătoare individuale)
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const countableDaysInMonth = daysInMonth - individualNonWorkingDays.length;

        // Numărul de zile de Grădiniță PREZENTE care sunt contorizabile (nu sunt marcate ca zi nelucrătoare individuală)
        const daysKindergarten = (monthData.days?.[id] || []).filter(d => !individualNonWorkingDays.includes(d)).length;

        const totalKindergartenCost = daysKindergarten * (rateKindergarten || 0);

        let totalExtraCost = 0;

        // --- Calcul Plăți ---
        const allPayments = monthData.payments?.[id] || [];
        const totalPaidKindergartenCurrentMonth = allPayments
            .filter(p => p.type === 'kindergarten')
            .reduce((sum, p) => sum + parseFloat(p.amount), 0);

        let totalPaidExtraCurrentMonth = 0;

        // --- Sumar Detaliat Activități Extra ---
        let extraDetailsHTML = '';
        if(childData.extraActivities && childData.extraActivities.length > 0){
            extraDetailsHTML += '<h4 style="margin-top:10px; margin-bottom:5px; color:#34495e;">Activități Suplimentare:</h4>';

            childData.extraActivities.forEach(activity => {
                // Prezența la activitățile extra NU este afectată de "Zi Nelucrătoare"
                const daysCount = monthData.extraAttendances?.[id]?.[activity.id]?.length || 0;
                const cost = daysCount * (activity.rate || 0);
                totalExtraCost += cost;

                const totalPaidForActivity = allPayments
                    .filter(p => p.type === activity.id)
                    .reduce((sum, p) => sum + parseFloat(p.amount), 0);

                totalPaidExtraCurrentMonth += totalPaidForActivity;

                if (daysCount > 0 || totalPaidForActivity > 0) {
                    extraDetailsHTML += `
                        <div style="font-size: 0.9em; padding: 4px 0 4px 10px; border-left: 2px solid #ecf0f1; margin-bottom: 5px;">
                            <strong>${sanitize(activity.name)}:</strong>
                            <div style="display:flex; justify-content:space-between;"><span>Cost (${daysCount} zile):</span> <span>${cost.toFixed(2)} lei</span></div>
                            <div style="display:flex; justify-content:space-between;"><span>Plătit:</span> <span>${totalPaidForActivity.toFixed(2)} lei</span></div>
                        </div>`;
                }
            });

            if(totalExtraCost > 0 || totalPaidExtraCurrentMonth > 0) {
                extraDetailsHTML += `
                    <div style="display:flex; justify-content:space-between; font-weight: bold; margin-top: 5px; padding-top: 5px; border-top: 1px dotted #ccc;">
                        <span>TOTAL Activități Suplimentare Cost:</span> <span>${totalExtraCost.toFixed(2)} lei</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-weight: bold; margin-bottom: 5px;">
                        <span>TOTAL Activități Suplimentare Plătit:</span> <span>${totalPaidExtraCurrentMonth.toFixed(2)} lei</span>
                    </div>`;
            }

        }

        const totalCalculatedCurrentMonth = totalKindergartenCost + totalExtraCost;
        const totalPaidCurrentMonth = totalPaidKindergartenCurrentMonth + totalPaidExtraCurrentMonth;

        // Calcul cost teoretic pentru luna, bazat pe zilele lucratoare
        const estimatedMonthlyKindergartenCost = countableDaysInMonth * rateKindergarten;
        const recommendedKindergartenPayment = Math.max(0, estimatedMonthlyKindergartenCost - previousMonthBalance);
        const finalBalance = (totalPaidCurrentMonth + previousMonthBalance) - totalCalculatedCurrentMonth;

        const div = document.createElement('div');
        div.className = 'child-report';
        div.innerHTML = `
            <h3>
                <span>${sanitize(childData.name)}</span>
                <button style="background:none; color:#2c3e50; font-size:1.4em; padding:0; margin:0;" onclick="showSettingsModal('${id}')">⚙️</button>
            </h3>
            <div style="font-weight: bold; color: ${previousMonthBalance >= 0 ? '#2ecc71' : '#e74c3c'}; border-bottom: 1px solid #ddd; padding-bottom: 8px; margin-bottom: 8px;">
                Sold Reportat Cumulativ: ${previousMonthBalance.toFixed(2)} lei
            </div>
            <div style="font-weight: bold; font-size: 1.1em; color: #3498db; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee;">
                Plată Estimată (bazat pe ${countableDaysInMonth} zile de plată): ${estimatedMonthlyKindergartenCost.toFixed(2)} lei
            </div>
            <div style="font-weight: bold; font-size: 1.1em; color: #3498db; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee;">
                Plată Recomandată Grădiniță: ${recommendedKindergartenPayment.toFixed(2)} lei
            </div>

            <hr style="border: 0; border-top: 1px dashed #ccc; margin: 15px 0;" />

            <div style="display:flex; justify-content:space-between;">
                <span>Cost Grădiniță (zile *prezente* și *plătibile* ${daysKindergarten}):</span> <span>${totalKindergartenCost.toFixed(2)} lei</span>
            </div>
             <div style="display:flex; justify-content:space-between;">
                <span>Plătit Grădiniță:</span> <span>${totalPaidKindergartenCurrentMonth.toFixed(2)} lei</span>
            </div>

            ${extraDetailsHTML}

            <div style="border-top: 1px solid #ddd; margin-top: 8px; padding-top: 8px; font-weight:bold;">
                <div style="display:flex; justify-content:space-between;"><span>TOTAL COST LUNAR:</span> <span>${totalCalculatedCurrentMonth.toFixed(2)} lei</span></div>
                <div style="display:flex; justify-content:space-between;"><span>TOTAL PLĂTIT LUNAR:</span> <span>${totalPaidCurrentMonth.toFixed(2)} lei</span></div>
            </div>

            <div style="font-weight: bold; font-size: 1.2em; color: ${finalBalance >= 0 ? '#2ecc71' : '#e74c3c'}; border-top: 2px solid #34495e; margin-top: 12px; padding-top: 12px;">
                <div style="display:flex; justify-content:space-between;"><span>BALANȚA FINALĂ:</span> <span>${finalBalance.toFixed(2)} lei</span></div>
            </div>
            <button style="width: 100%; margin-top: 15px; background: #2ecc71;" onclick="showPaymentsModal('${id}')">Vezi/Adaugă Plăți</button>
        `;
        container.appendChild(div);
    }
};

/* ================== Payments Modal ================== */
const showPaymentsModal = (childId) => {
    selectedChildIdForModal = childId;
    const data = loadData();
    const child = data.children[childId];
    const monthName = new Date(year, month).toLocaleString('ro-RO', { month: 'long' });
    document.getElementById('paymentsChildName').textContent = sanitize(child.name);
    document.getElementById('paymentsMonth').textContent = monthName;

    const paymentTypeSelect = document.getElementById('newPaymentType');
    paymentTypeSelect.innerHTML = `<option value="kindergarten">Grădiniță</option>`;
    if (child.extraActivities) {
        child.extraActivities.forEach(activity => {
            const option = document.createElement('option');
            option.value = activity.id;
            option.textContent = sanitize(activity.name);
            paymentTypeSelect.appendChild(option);
        });
    }

    renderPaymentList();
    openModal('paymentsModal');
};

const renderPaymentList = () => {
    const data = loadData();
    const key = `${year}-${month}`;
    const childId = selectedChildIdForModal;
    const childData = data.children[childId];
    const paymentList = document.getElementById('paymentList');
    paymentList.innerHTML = '';

    const payments = data[key]?.payments?.[childId] || [];
    let totalPaid = 0;

    payments.sort((a,b) => new Date(a.date) - new Date(b.date));

    payments.forEach((payment, index) => {
        totalPaid += parseFloat(payment.amount);

        let paymentTypeLabel = 'Necunoscut';
        if (payment.type === 'kindergarten') {
            paymentTypeLabel = 'Grădiniță';
        } else {
            const activity = childData.extraActivities.find(act => act.id === payment.type);
            paymentTypeLabel = activity ? activity.name : 'Activitate Ștearsă';
        }

        const li = document.createElement('li');
        li.innerHTML = `
            <span>${payment.date} - ${parseFloat(payment.amount).toFixed(2)} lei (${sanitize(paymentTypeLabel)})</span>
            <button onclick="deletePayment(${index})">&times;</button>
        `;
        paymentList.appendChild(li);
    });
    document.getElementById('paymentsTotal').textContent = totalPaid.toFixed(2);
};

const addPayment = () => {
    const data = loadData();
    const key = `${year}-${month}`;
    const childId = selectedChildIdForModal;
    const amount = parseFloat(document.getElementById('newPaymentAmount').value);
    const dateStr = document.getElementById('newPaymentDate').value;
    const type = document.getElementById('newPaymentType').value;

    if (isNaN(amount) || amount <= 0 || !dateStr) {
        alert("Introduceți o sumă și o dată valide.");
        return;
    }
    const date = new Date(dateStr);
    const day = date.getDate();
    if (date.getFullYear() !== year || date.getMonth() !== month) {
         if (!confirm(`Data selectată (${dateStr}) nu este în luna curentă. Doriți să o adăugați oricum?`)) {
             return;
         }
    }

    if (!data[key].payments) data[key].payments = {};
    if (!data[key].payments[childId]) data[key].payments[childId] = [];
    const paymentColor = document.getElementById('newPaymentColor').value;

    data[key].payments[childId].push({ amount: amount, date: dateStr, type: type, color: paymentColor });

    if(!data[key].paymentsOnDay) data[key].paymentsOnDay = {};
    if(!data[key].paymentsOnDay[day]) data[key].paymentsOnDay[day] = [];
    data[key].paymentsOnDay[day].push({ childId: childId, amount: amount, color: paymentColor, timestamp: Date.now() });

    saveData(data);
    document.getElementById('newPaymentAmount').value = '';
    document.getElementById('newPaymentDate').value = '';
    renderPaymentList();
    renderChildrenReports();
    renderCalendar();
};

const deletePayment = (index) => {
    const data = loadData();
    const key = `${year}-${month}`;
    const childId = selectedChildIdForModal;
    if (confirm('Ești sigur că vrei să ștergi această plată?')) {
        const paymentToDelete = data[key].payments[childId][index];
        const date = new Date(paymentToDelete.date);
        const day = date.getDate();
        data[key].payments[childId].splice(index, 1);
        if(data[key].paymentsOnDay && data[key].paymentsOnDay[day]) {
            const idx = data[key].paymentsOnDay[day].findIndex(p =>
                p.childId === childId &&
                p.amount === paymentToDelete.amount &&
                p.color === paymentToDelete.color &&
                new Date(paymentToDelete.date).getDate() === day
            );
            if(idx > -1) {
                data[key].paymentsOnDay[day].splice(idx, 1);
            }
            if(data[key].paymentsOnDay[day].length === 0) delete data[key].paymentsOnDay[day];
        }
        saveData(data);
        renderPaymentList();
        renderChildrenReports();
        renderCalendar();
    }
};

/* ================== EXPORT / IMPORT ================== */
const exportJSON = () => {
    const data = loadData();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `gradinita_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
};

const importJSON = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const obj = JSON.parse(e.target.result);
            saveData(obj);
            alert('Import finalizat. Datele locale au fost înlocuite.');
            renderCalendar();
        } catch (err) {
            alert('Fișier JSON invalid.');
        }
    };
    reader.readAsText(file);
    event.target.value = '';
};

const exportExcel = () => { /* ... (necesită adaptare) ... */ };
const exportPDF = () => { /* ... (necesită adaptare) ... */ };

/* ================== Resetare date ================== */
const resetData = () => {
    if (!confirm('Sigur vrei să ștergi toate datele stocate local? Această acțiune nu se poate anula.')) return;
    localStorage.removeItem(STORAGE_KEY);
    month = new Date().getMonth();
    year = new Date().getFullYear();
    init(true);
};

/* ================== Navigare lună / an ================== */
const changeMonth = (offset) => {
    month += offset;
    if (month < 0) { month = 11; year -= 1; }
    if (month > 11) { month = 0; year += 1; }
    today = new Date(year, month, 1);
    document.getElementById('yearSelectNav').value = year;
    document.getElementById('monthSelectNav').value = month;
    renderCalendar();
};

const changeMonthToSelected = () => {
    month = parseInt(document.getElementById('monthSelectNav').value);
    year = parseInt(document.getElementById('yearSelectNav').value);
    renderCalendar();
};

/* ================== Legendă culori ================== */
const renderLegend = () => {
    const data = loadData();
    const legend = document.getElementById('legend');
    legend.innerHTML = '';
    const children = data.children || {};

    for (const childId of Object.keys(children)) {
        const child = children[childId];
        let itemHTML = `<div class="legend-item"><div class="color-box" style="background:${child.color}"></div><div>${sanitize(child.name)} - Grădiniță</div></div>`;
        if(child.extraActivities){
            child.extraActivities.forEach(activity => {
                itemHTML += `<div class="legend-item"><div class="color-box" style="background:${activity.color}"></div><div>${sanitize(child.name)} - ${sanitize(activity.name)}</div></div>`;
            });
        }
        legend.innerHTML += itemHTML;
    }
    legend.innerHTML += `<div class="legend-item"><div class="color-box" style="background:#bdc3c7; border: 1px dashed #7f8c8d;"></div><div>Absent</div></div>`;
    legend.innerHTML += `<div class="legend-item"><div class="color-box" style="background:#e8f4fb;"></div><div>Zi Nelucrătoare (Individuală)</div></div>`;
    legend.innerHTML += `<div class="legend-item"><div class="color-box" style="background:#fcebeb; border-color: #e74c3c;"></div><div>Sărbătoare Legală (Globală)</div></div>`;
    legend.innerHTML += `<div class="legend-item"><div class="color-box" style="background:#2ecc71"></div><div>Indicator Plată</div></div>`;
};

/* ================== Grafic ================== */
const renderChart = () => {
    const data = loadData();
    const key = `${year}-${month}`;
    const children = data.children || {};
    const labels = [];
    const kindergartenData = [];
    const extraData = [];
    const extraColors = [];

    for (const id of Object.keys(children)) {
        labels.push(children[id].name);

        const individualNonWorkingDays = data[key]?.individualNonWorkingDays?.[id] || [];
        // Zile de prezență Grădiniță care NU sunt zile nelucrătoare
        const countableDays = (data[key]?.days?.[id] || []).filter(d => !individualNonWorkingDays.includes(d)).length;

        kindergartenData.push(countableDays);

        let totalExtraDays = 0;
        if(children[id].extraActivities && data[key]?.extraAttendances?.[id]){
            for(const activity of children[id].extraActivities){
                totalExtraDays += (data[key].extraAttendances[id][activity.id] || []).length;
            }
        }
        extraData.push(totalExtraDays);
        extraColors.push(children[id].extraActivities?.[0]?.color || '#9b59b6');
    }

    const ctx = document.getElementById('myChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Zile Grădiniță Contorizabile',
                    data: kindergartenData,
                    backgroundColor: Object.values(children).map(c => c.color || '#3498db')
                },
                {
                    label: 'Zile Activități Suplimentare (Total)',
                    data: extraData,
                    backgroundColor: extraColors
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Număr de zile' } }
            },
            plugins: {
                title: { display: true, text: `Prezența copiilor în luna ${new Date(year, month).toLocaleString('ro-RO', { month: 'long' })}` }
            }
        }
    });
};

/* ================== Raport general ================== */
const showGeneralReportModal = () => { /* ... (necesită adaptare) ... */ };
const generateGeneralReport = () => { /* ... (necesită adaptare) ... */ };

/* ================== Backup automat ================== */
const autoBackup = () => {
    const now = Date.now();
    const lastBackup = localStorage.getItem('lastBackupTime');
    if (!lastBackup || (now - lastBackup > BACKUP_INTERVAL_MS)) {
        exportJSON();
        localStorage.setItem('lastBackupTime', now);
        console.log("Auto-backup completed.");
    }
};

/* ================== Inițializare ================== */
const init = (forceReset = false) => {
    let data = loadData();
    const currentMonthDataKey = `${year}-${month}`;

    if (forceReset || !data.children || Object.keys(data.children).length === 0) {
        data = { children: {} };
        const id1 = 'c1';
        const id2 = 'c2';
        data.children[id1] = { name: 'Casian', defaultRate: 15, color: '#4da6ff', extraActivities: [{ id: 'e1', name: 'Engleză', rate: 20, color: '#9b59b6' }, { id: 'e2', name: 'Sport', rate: 18, color: '#f1c40f' }] };
        data.children[id2] = { name: 'Ezra', defaultRate: 15, color: '#ffd633', extraActivities: [{ id: 'e3', name: 'Engleză', rate: 20, color: '#ff6f61' }] };
    }

    // NOU: Asigură-te că există structura lunară
    if (!data[currentMonthDataKey]) {
        data[currentMonthDataKey] = {
            days: {}, extraAttendances: {}, absences: {}, rates: {}, notes: {}, payments: {},
            globalHolidays: [],
            individualNonWorkingDays: {},
            paymentsOnDay: {}
        };
    }

    // Logică pentru a asigura că zilele de weekend sunt în individualNonWorkingDays pentru toți copiii
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const defaultNonWorkingDays = [];
    for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(year, month, d);
        if (date.getDay() === 0 || date.getDay() === 6) { // 0=Duminica, 6=Sambata
            defaultNonWorkingDays.push(d);
        }
    }

    for(const childId in data.children) {
        if(!data[currentMonthDataKey].individualNonWorkingDays[childId]) {
            // Inițializează weekend-urile doar dacă nu există date pentru copil
            data[currentMonthDataKey].individualNonWorkingDays[childId] = [...defaultNonWorkingDays];
        }
    }

    // Daca datele vechi foloseau "holidays", le mutam in "globalHolidays"
    if (data[currentMonthDataKey].holidays) {
        data[currentMonthDataKey].globalHolidays = data[currentMonthDataKey].holidays;
        delete data[currentMonthDataKey].holidays;
    }


    saveData(data);

    document.getElementById('yearSelectNav').value = year;
    document.getElementById('monthSelectNav').value = month;
    renderCalendar();

    // Analytics summary script
    if (typeof gtag === 'function') {
        try {
            const currentData = loadData();
            const childCount = Object.keys(currentData.children).length;
            let activityCount = 0;
            for (const childId in currentData.children) {
                if (currentData.children[childId].extraActivities) {
                    activityCount += currentData.children[childId].extraActivities.length;
                }
            }
            // Trimite un eveniment sumar la încărcarea aplicației
            gtag('event', 'load_summary', {
                'child_count': childCount,
                'activity_count': activityCount
            });
        } catch (e) {
            console.error("Analytics summary failed", e);
        }
    }

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => console.log('ServiceWorker registration successful'))
                .catch(error => console.log('ServiceWorker registration failed: ', error));
        });
    }
};

init();

</script>
</body>
</html>
